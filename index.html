<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Management System - Multi-user</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="text-xl font-bold text-gray-700">Loading...</div>
                <div class="text-sm text-gray-500 mt-2">Connecting to database...</div>
            </div>
        </div>
    </div>
    
    <script>
        // ====================================
        // FIREBASE CONFIGURATION
        // ====================================
       const firebaseConfig = {
  apiKey: "AIzaSyBADUfV7Q0ZnVHRnLNjzX7_ZMS_6z9e8F4",
  authDomain: "dd-management-system.firebaseapp.com",
  databaseURL: "https://dd-management-system-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dd-management-system",
  storageBucket: "dd-management-system.firebasestorage.app",
  messagingSenderId: "255843275",
  appId: "1:255843275:web:b3da6f1ce07fb1f7b4f44e"
};

        let db, auth, currentUser;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            console.log('Firebase initialized');
        } catch (error) {
            console.error('Firebase error:', error);
            alert('Firebase belum dikonfigurasi! Silakan ganti firebaseConfig di baris 27-34');
        }

        // State Management
        const state = {
    activeTab: 'dashboard',
    showAddModal: false,
    showDetailModal: false,
    showEditResponsibilityModal: false,
    showAddLetterModal: false,
    showAddPOModal: false,
    showEditPOModal: false,  // ← TAMBAHKAN INI
    showEditBasicInfoModal: false,
    showStageDetailModal: false,
    selectedItem: null,
    editBasicInfo: null,
    selectedStageType: null,
    editPO: null,  // ← TAMBAHKAN INI
            searchTerm: '',
            filterStatus: 'all',
            filterOwnership: 'all',
            newLetter: { date: '', letterNo: '', from: 'Owner', to: '', subject: '', type: 'Notification' },
            newPO: { type: 'Contract Service', poNumber: '', vendor: '', value: 0, description: '' },
            defects: [],
            newDefect: {
                title: '', equipment: '', unitDescription: '' , location: '', phase: 'commissioning', discipline: 'Static',
                defectDate: '', targetDate: '', reportedBy: '', description: '',
                rootCause: '', costEstimate: 0, responsibility: null, isCritical: false
            },
            isLoading: true,
            currentUserName: 'Anonymous User'
        };

        // ====================================
        // FIREBASE AUTH & DATABASE
        // ====================================
        async function initAuth() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        state.currentUserName = 'User-' + user.uid.substring(0, 6);
                        resolve(user);
                    } else {
                        try {
                            const userCredential = await auth.signInAnonymously();
                            currentUser = userCredential.user;
                            state.currentUserName = 'User-' + currentUser.uid.substring(0, 6);
                            resolve(currentUser);
                        } catch (error) {
                            reject(error);
                        }
                    }
                });
            });
        }

  // ====================================
        // ONLINE PRESENCE SYSTEM
        // ====================================
        let onlineUsersCount = 0;
        let presenceRef = null;

        async function setupPresence() {
            if (!currentUser) return;
            
            const userStatusDatabaseRef = db.ref('/status/' + currentUser.uid);
            const isOfflineForDatabase = {
                state: 'offline',
                last_changed: firebase.database.ServerValue.TIMESTAMP,
            };
            const isOnlineForDatabase = {
                state: 'online',
                last_changed: firebase.database.ServerValue.TIMESTAMP,
                name: state.currentUserName
            };
            
            // Firebase special path to detect connection
            db.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    return;
                }
                
                // Set user as online
                userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(() => {
                    userStatusDatabaseRef.set(isOnlineForDatabase);
                });
            });
            
            // Listen to all online users
            presenceRef = db.ref('/status');
            presenceRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    onlineUsersCount = Object.values(data).filter(u => u.state === 'online').length;
                } else {
                    onlineUsersCount = 0;
                }
                render(); // Re-render to update count
            });
        }

        function listenToDefects() {
    db.ref('defects').on('value', (snapshot) => {
        // PRESERVE SCROLL POSITION for Stage Detail Modal
        let stageModalScroll = 0;
        const stageModal = document.querySelector('.fixed.inset-0 .max-w-5xl .overflow-y-auto');
        if (stageModal) {
            stageModalScroll = stageModal.scrollTop;
        }
        
        // PRESERVE SCROLL POSITION for Detail Modal (main defect modal)
        let detailModalScroll = 0;
        const detailModal = document.querySelector('.fixed.inset-0 .max-w-6xl');
        if (detailModal) {
            detailModalScroll = detailModal.scrollTop;
        }
        
        const data = snapshot.val();
        state.defects = data ? Object.keys(data).map(key => {
            const defect = {...data[key], firebaseKey: key};
            if (!defect.completedSteps) defect.completedSteps = [];
            if (!defect.letters) defect.letters = [];
            if (!defect.pos) defect.pos = [];
            if (!defect.history) defect.history = [];
            return defect;
        }) : [];
        state.isLoading = false;
        render();
        
        // RESTORE SCROLL POSITION for both modals
        requestAnimationFrame(() => {
            // Restore Stage Modal scroll
            if (stageModalScroll > 0) {
                const newStageModal = document.querySelector('.fixed.inset-0 .max-w-5xl .overflow-y-auto');
                if (newStageModal) {
                    newStageModal.scrollTop = stageModalScroll;
                }
            }
            
            // Restore Detail Modal scroll
            if (detailModalScroll > 0) {
                const newDetailModal = document.querySelector('.fixed.inset-0 .max-w-6xl');
                if (newDetailModal) {
                    newDetailModal.scrollTop = detailModalScroll;
                }
            }
        });
    });
}

        async function saveDefectToFirebase(defect) {
            try {
                const defectData = {...defect};
                delete defectData.firebaseKey;
 if (!defectData.letters) defectData.letters = [];
        if (!defectData.pos) defectData.pos = [];
        if (!defectData.completedSteps) defectData.completedSteps = [];
        if (!defectData.ownerAction) defectData.ownerAction = [];
        if (!defectData.history) defectData.history = [];


                if (defect.firebaseKey) {
                    await db.ref('defects/' + defect.firebaseKey).set(defectData);
                } else {
                    const newRef = db.ref('defects').push();
                    await newRef.set(defectData);
                }
                return true;
            } catch (error) {
                alert('Error: ' + error.message);
                return false;
            }
        }

        async function deleteDefectFromFirebase(firebaseKey) {
            try {
                await db.ref('defects/' + firebaseKey).remove();
                return true;
            } catch (error) {
                alert('Error: ' + error.message);
                return false;
            }
        }

        // ====================================
        // ORIGINAL FUNCTIONS (UNCHANGED)
        // ====================================
        
        function getInitialContractServiceStages() {
            const stages = ['Scope Develop', 'Vendor Searching', 'Vendor Challenge', 'Pembuatan linkup',
                'Pembuatan Owner Estimate', 'TKDN & Risk Assessment', 'Pengajuan izin anggaran',
                'Pengajuan izin metode pengadaan dan perizinan Perpres ve Procurement',
                'Proses pra tender', 'Prebid Meeting', 'Penawaran dari calon vendor',
                'Evaluasi administrasi dan teknis', 'Pembuatan sampul 2', 'Evaluasi komersiil',
                'Penetapan pemenang', 'Pekerjaan kontrak', 'Pekerjaan', 'Izin SPBMK',
                'Pelaksanaan Kick-off meeting'];
            return stages.map(name => ({ name, status: 'not-started', notes: '', targetDate: '', actualDate: '' }));
        }

        function getInitialMaterialProcurementStages() {
            const stages = ['Scope Develop', 'Vendor Searching', 'Vendor Challenge', 'Pembuatan linkup',
                'Pembuatan Owner Estimate', 'TKDN & Risk Assessment', 'Pengajuan izin anggaran',
                'Pengajuan izin metode pengadaan dan perizinan Perpres ve Procurement',
                'Proses pra tender', 'Prebid Meeting', 'Penawaran dari calon vendor',
                'Evaluasi administrasi dan teknis', 'Pembuatan sampul 2', 'Evaluasi komersiil',
                'Penetapan pemenang', 'Pekerjaan kontrak', 'Pekerjaan', 'Izin SPBMK',
                'Pelaksanaan Kick-off meeting'];
            return stages.map(name => ({ name, status: 'not-started', notes: '', targetDate: '', actualDate:'' }));
        }

        function formatRupiah(amount) {
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(amount);
        }

// Unit Description Options
const UNIT_OPTIONS = [
    '001R - CDU Revamp',
    '001N - CDU Preflash',
    '002 - VDU',
    '003A - HCU Train A',
    '003B - HCU Train B',
    '003C - HCU Common Facilities',
    '052 - Residue Fluid Catalytic Cracking',
    '053 - RFCC Naphtha Hydrotreating Unit',
    '054 - Diesel Hydrotreating Unit',
    '059 - CCR Platforming',
    '060 - Saturated Gas Concentration Unit',
    '062 - RFCC LPG Treating Unit',
    '063 - Propylene Recovery Unit',
    '064 - Saturated LPG Treating Unit',
    '065 - Alkylation',
    '066 - Wet Gas Sulfuric Acid',
    '067 - Non-RFCC Sour Water Stripping',
    '068 - Hydrogen Manufacturing Unit',
    '069 - Amine Regeneration Unit I',
    '079 - Amine Regeneration Unit II',
    '082 - Isomerization',
    '083 - Diesel Hydrotreating Unit II',
    '084 - Naphtha Hydrotreating Unit',
    '085 - Common DHT H2 Compressor',
    '160 - Common Facilities – NLP1',
    '167 - RFCC Sour Water Stripping',
    '169 - Sulfur Recovery Unit',
    '315 - Fuel Oil & Gas System',
    '319 - Flare System - RFCC',
    '319 - Flare System - HCC',
    '320 - Plant Feed & Product Tank',
    '323 - New Product Jetty',
    '325 - Spent Caustic & Chem. Prep. System',
    '331 - Steam & Power Generation',
    '332 - Cooling Water System',
    '334 - Waste Water Treatment Plant',
    '335 - Air System',
    '337 - Sea Water Intake System',
    '420 - Tankage Unit'
];


        function getStats() {
            return {
                total: state.defects.length,
                open: state.defects.filter(d => d.status === 'Open').length,
                inProgress: state.defects.filter(d => d.status === 'In Progress').length,
                closed: state.defects.filter(d => d.status === 'Closed').length,
                byPhase: {
                    commissioning: state.defects.filter(d => d.phase === 'commissioning').length,
                    startup: state.defects.filter(d => d.phase === 'startup').length,
                    oa: state.defects.filter(d => d.phase === 'oa').length,
                    fa: state.defects.filter(d => d.phase === 'fa').length,
                    warranty: state.defects.filter(d => d.phase === 'warranty').length
                },
                avgProgress: state.defects.length > 0 ? Math.round(state.defects.reduce((sum, d) => sum + (d.workProgress || 0), 0) / state.defects.length) : 0,
                totalCONegative: state.defects.filter(d => d.takeoverInitiated).reduce((sum, d) => sum + (d.coNegative || 0), 0),
                takeoverCount: state.defects.filter(d => d.takeoverInitiated).length,
                ownerOriginal: state.defects.filter(d => d.responsibility === 'Owner' && !d.takeoverInitiated).length
            };
        }

        function getFilteredDefects() {
            return state.defects.filter(d => {
                const matchSearch = !state.searchTerm || 
                    d.title.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                    d.id.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                    d.equipment.toLowerCase().includes(state.searchTerm.toLowerCase());
                const matchStatus = state.filterStatus === 'all' || d.status === state.filterStatus;
                const matchOwnership = state.filterOwnership === 'all' || 
                    (state.filterOwnership === 'owner-original' && d.responsibility === 'Owner' && !d.takeoverInitiated) ||
                    (state.filterOwnership === 'takeover' && d.takeoverInitiated) ||
                    (state.filterOwnership === 'contractor' && d.responsibility === 'Contractor' && !d.takeoverInitiated);
                return matchSearch && matchStatus && matchOwnership;
            });
        }

        function setActiveTab(tab) { state.activeTab = tab; render(); }
        function setSearchTerm(term) { state.searchTerm = term; render(); }
        function setFilter(value) { state.filterStatus = value; render(); }
        function setOwnershipFilter(value) { state.filterOwnership = value; render(); }

function renderWithScrollPreserve() {
     let modalScroll = 0;
    const modalContainer = document.querySelector('.fixed.inset-0 .bg-white.rounded-lg.max-w-6xl');
    if (modalContainer) {
        modalScroll = modalContainer.scrollTop;
    }

    render();
    requestAnimationFrame(() => {
        const newModalContainer = document.querySelector('.fixed.inset-0 .bg-white.rounded-lg.max-w-6xl');
        if (newModalContainer && modalScroll > 0) {
            newModalContainer.scrollTop = modalScroll;
        }
    });
}

        function openAddModal() { state.showAddModal = true; render(); }
        function closeAddModal() { 
            state.showAddModal = false;
            state.newDefect = { title: '', equipment: '',  unitDescription: '', location: '', phase: 'commissioning', defectDate: '', targetDate: '', reportedBy: '', description: '', rootCause: '', costEstimate: 0, responsibility: null, isCritical: false };
            render();
        }
        
       function openDetailModal(defectId) { 
    const defect = state.defects.find(d => d.id === defectId);
    if (defect) {
        state.selectedItem = JSON.parse(JSON.stringify(defect));
        
        // COMPREHENSIVE INITIALIZATION - untuk backward compatibility dengan data lama
        if (!state.selectedItem.completedSteps) state.selectedItem.completedSteps = [];
        if (!state.selectedItem.letters) state.selectedItem.letters = [];
        if (!state.selectedItem.pos) state.selectedItem.pos = [];
        if (!state.selectedItem.history) state.selectedItem.history = [];
        if (!state.selectedItem.ownerAction) state.selectedItem.ownerAction = [];
        
        // Initialize contract service stages
        if (!state.selectedItem.contractServiceStages) {
            state.selectedItem.contractServiceStages = getInitialContractServiceStages();
        }
        
        // Initialize material procurement stages
        if (!state.selectedItem.materialProcurementStages) {
            state.selectedItem.materialProcurementStages = getInitialMaterialProcurementStages();
        }
        
        // Initialize evidence assessment dengan NESTED properties
        if (!state.selectedItem.evidenceAssessment) {
            state.selectedItem.evidenceAssessment = {
                evidences: [],
                contractReview: '',
                technicalJustification: '',
                thirdPartyAssessment: '',
                ownerDecision: null,
                decisionJustification: ''
            };
        } else {
            // Pastikan nested properties ada
            if (!state.selectedItem.evidenceAssessment.evidences) {
                state.selectedItem.evidenceAssessment.evidences = [];
            }
            if (!state.selectedItem.evidenceAssessment.contractReview) {
                state.selectedItem.evidenceAssessment.contractReview = '';
            }
            if (!state.selectedItem.evidenceAssessment.technicalJustification) {
                state.selectedItem.evidenceAssessment.technicalJustification = '';
            }
            if (!state.selectedItem.evidenceAssessment.thirdPartyAssessment) {
                state.selectedItem.evidenceAssessment.thirdPartyAssessment = '';
            }
            if (!state.selectedItem.evidenceAssessment.decisionJustification) {
                state.selectedItem.evidenceAssessment.decisionJustification = '';
            }
        }
        
        // Initialize other missing properties
        if (!state.selectedItem.contractorResponse) state.selectedItem.contractorResponse = null;
        if (!state.selectedItem.workProgress) state.selectedItem.workProgress = 0;
        if (!state.selectedItem.progressNotes) state.selectedItem.progressNotes = '';
        if (state.selectedItem.takeoverInitiated === undefined) state.selectedItem.takeoverInitiated = false;
        if (!state.selectedItem.coNegative) state.selectedItem.coNegative = 0;
        
        state.showDetailModal = true; 
        render(); 
    }
}
        
        function closeDetailModal() { state.showDetailModal = false; state.selectedItem = null; render(); }
        function openEditResponsibilityModal() { state.showEditResponsibilityModal = true; render(); }
        function closeEditResponsibilityModal() { state.showEditResponsibilityModal = false; render(); }
        function openAddLetterModal() { 
            state.showAddLetterModal = true; 
            state.newLetter = { date: new Date().toISOString().split('T')[0], letterNo: '', from: '', to: '', subject: '', type: 'Notification' };
            render(); 
        }
        function closeAddLetterModal() { state.showAddLetterModal = false; render(); }
        function openAddPOModal() { 
            state.showAddPOModal = true; 
            const defaultType = (state.selectedItem.ownerAction && state.selectedItem.ownerAction.length > 0) ? state.selectedItem.ownerAction[0] : 'Contract Service';
            state.newPO = { type: defaultType, poNumber: '', vendor: '', value: 0, description: '' };
            render(); 
        }
        function closeAddPOModal() { state.showAddPOModal = false; render(); }

function openEditPOModal(poId) {
    const po = state.selectedItem.pos.find(p => p.id === poId);
    if (po) {
        state.showEditPOModal = true;
        state.editPO = { ...po }; // Copy PO data
        render();
    }
}

function closeEditPOModal() {
    state.showEditPOModal = false;
    state.editPO = null;
    render();
}

async function updatePO() {
    if (!state.editPO.poNumber || !state.editPO.vendor || !state.editPO.value) {
        alert('Mohon isi PO Number, Vendor, dan Value');
        return;
    }
    
    const poIndex = state.selectedItem.pos.findIndex(p => p.id === state.editPO.id);
    if (poIndex > -1) {
        state.selectedItem.pos[poIndex] = { ...state.editPO };
        addHistory('PO Updated', state.editPO.type + ': ' + state.editPO.poNumber + ' - ' + formatRupiah(state.editPO.value));
        await saveDefect();
        closeEditPOModal();
        alert('PO berhasil diupdate');
    }
}

        function openEditBasicInfoModal() {
            state.showEditBasicInfoModal = true;
            state.editBasicInfo = {
                title: state.selectedItem.title, equipment: state.selectedItem.equipment, unitDescription: state.selectedItem.unitDescription || '',
                location: state.selectedItem.location, phase: state.selectedItem.phase,
                discipline: state.selectedItem.discipline || 'Static',
                defectDate: state.selectedItem.defectDate, targetDate: state.selectedItem.targetDate,
                reportedBy: state.selectedItem.reportedBy, description: state.selectedItem.description,
                rootCause: state.selectedItem.rootCause, costEstimate: state.selectedItem.costEstimate,
                isCritical: state.selectedItem.isCritical || false
            };
            render();
        }

        function closeEditBasicInfoModal() { state.showEditBasicInfoModal = false; state.editBasicInfo = null; render(); }
        function openStageDetailModal(type) { state.showStageDetailModal = true; state.selectedStageType = type; render(); }
        function closeStageDetailModal() { state.showStageDetailModal = false; state.selectedStageType = null; render(); }
        function updateEditBasicInfo(field, value) { state.editBasicInfo[field] = value; }

        async function updateStageStatus(index, status) {
    if (state.selectedStageType === 'Contract Service') {
        state.selectedItem.contractServiceStages[index].status = status;
        // Set actual date when completed
        if (status === 'completed' && !state.selectedItem.contractServiceStages[index].actualDate) {
            state.selectedItem.contractServiceStages[index].actualDate = new Date().toISOString().split('T')[0];
        }
    } else if (state.selectedStageType === 'Material Procurement') {
        state.selectedItem.materialProcurementStages[index].status = status;
        // Set actual date when completed
        if (status === 'completed' && !state.selectedItem.materialProcurementStages[index].actualDate) {
            state.selectedItem.materialProcurementStages[index].actualDate = new Date().toISOString().split('T')[0];
        }
    }
    addHistory('Stage Updated', state.selectedStageType + ' stage set to ' + status);
    await saveDefect();
    // Don't render - just save silently
}

        async function updateStageNotes(index, notes) {
            if (state.selectedStageType === 'Contract Service') {
                state.selectedItem.contractServiceStages[index].notes = notes;
            } else if (state.selectedStageType === 'Material Procurement') {
                state.selectedItem.materialProcurementStages[index].notes = notes;
            }
            await saveDefect();
        }

        async function updateStageTargetDate(index, targetDate) {
            if (state.selectedStageType === 'Contract Service') {
                state.selectedItem.contractServiceStages[index].targetDate = targetDate;
            } else if (state.selectedStageType === 'Material Procurement') {
                state.selectedItem.materialProcurementStages[index].targetDate = targetDate;
            }
            await saveDefect();
        }

async function updateStageActualDate(index, actualDate) {
    if (state.selectedStageType === 'Contract Service') {
        state.selectedItem.contractServiceStages[index].actualDate = actualDate;
    } else if (state.selectedStageType === 'Material Procurement') {
        state.selectedItem.materialProcurementStages[index].actualDate = actualDate;
    }
    await saveDefect();
}

        function updateSelfRepairExecutor(executor) { state.selectedItem.selfRepairExecutor = executor; }

        async function confirmSelfRepairExecutor() {
            if (!state.selectedItem.selfRepairExecutor) {
                alert('Mohon isi nama pelaksana Self Repair');
                return;
            }
            addHistory('Self Repair Executor', 'Dikerjakan oleh: ' + state.selectedItem.selfRepairExecutor);
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function addEvidence(type, description) {
            if (!description) {
                alert('Mohon isi deskripsi evidence');
                return;
            }
            const newEvidence = {
                id: (state.selectedItem.evidenceAssessment.evidences.length + 1),
                type: type, description: description,
                date: new Date().toISOString().split('T')[0],
                uploadedBy: state.currentUserName
            };
            state.selectedItem.evidenceAssessment.evidences.push(newEvidence);
            addHistory('Evidence Added', type + ': ' + description);
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function deleteEvidence(evidenceId) {
            if (confirm('Hapus evidence ini?')) {
                state.selectedItem.evidenceAssessment.evidences = 
                    state.selectedItem.evidenceAssessment.evidences.filter(e => e.id !== evidenceId);
                await saveDefect();
                renderWithScrollPreserve();
            }
        }

        async function updateAssessmentField(field, value) {
            state.selectedItem.evidenceAssessment[field] = value;
            await saveDefect();
        }

        async function makeOwnerDecision(decision) {
            if (!state.selectedItem.evidenceAssessment.decisionJustification) {
                alert('Mohon isi justifikasi keputusan');
                return;
            }
            state.selectedItem.evidenceAssessment.ownerDecision = decision;
            if (decision === 'force-co-negative') {
                state.selectedItem.currentStep = 'takeover';
                state.selectedItem.completedSteps.push('evidence-assessment');
                addHistory('Owner Decision: Force CO Negatif', 'Based on evidence - ' + state.selectedItem.evidenceAssessment.decisionJustification);
            } else if (decision === 'negotiate') {
                state.selectedItem.completedSteps.push('evidence-assessment');
                addHistory('Owner Decision: Negotiate/Mediate', 'Attempting resolution - ' + state.selectedItem.evidenceAssessment.decisionJustification);
                alert('Status: Negotiation. Anda dapat update progress di notes atau kembali ke step ini jika perlu.');
            } else if (decision === 'owner-accept') {
                state.selectedItem.responsibility = 'Owner';
                state.selectedItem.currentStep = 'owner-action';
                state.selectedItem.completedSteps = ['evidence-assessment'];
                state.selectedItem.takeoverInitiated = false;
                addHistory('Owner Decision: Accept Responsibility', 'Evidence insufficient - ' + state.selectedItem.evidenceAssessment.decisionJustification);
            }
            await saveDefect();
            renderWithScrollPreserve();
        }

        function getStageSummary(type) {
    const stages = type === 'Contract Service' ? state.selectedItem.contractServiceStages : state.selectedItem.materialProcurementStages;
    const completed = stages.filter(s => s.status === 'completed').length;
    const inProgress = stages.filter(s => s.status === 'in-progress').length;
    const notStarted = stages.filter(s => s.status === 'not-started').length;
    const notRequired = stages.filter(s => s.status === 'not-required').length;
    const relevantTotal = stages.length - notRequired; // FIX: Exclude not-required from total
    return { completed, inProgress, notStarted, notRequired, total: stages.length, relevantTotal: relevantTotal };
}

        function renderStageSummaryBadges(type) {
            const summary = getStageSummary(type);
            return '<div class="flex gap-2 mt-2 flex-wrap">' +
                '<span class="px-2 py-1 text-xs font-bold rounded bg-green-100 text-green-700">✓ ' + summary.completed + '</span>' +
                '<span class="px-2 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700">▶ ' + summary.inProgress + '</span>' +
                '<span class="px-2 py-1 text-xs font-bold rounded bg-yellow-100 text-yellow-700">⏸ ' + summary.notStarted + '</span>' +
                '<span class="px-2 py-1 text-xs font-bold rounded bg-gray-100 text-gray-700">✕ ' + summary.notRequired + '</span></div>';
        }

        async function saveBasicInfo() {
            if (!state.editBasicInfo.title || !state.editBasicInfo.equipment) {
                alert('Mohon lengkapi Title dan Equipment');
                return;
            }
            state.selectedItem.title = state.editBasicInfo.title;
            state.selectedItem.equipment = state.editBasicInfo.equipment;
state.selectedItem.unitDescription = state.editBasicInfo.unitDescription;
            state.selectedItem.location = state.editBasicInfo.location;
            state.selectedItem.phase = state.editBasicInfo.phase;
            state.selectedItem.discipline = state.editBasicInfo.discipline;
            state.selectedItem.defectDate = state.editBasicInfo.defectDate;
            state.selectedItem.targetDate = state.editBasicInfo.targetDate;
            state.selectedItem.reportedBy = state.editBasicInfo.reportedBy;
            state.selectedItem.description = state.editBasicInfo.description;
            state.selectedItem.rootCause = state.editBasicInfo.rootCause;
            state.selectedItem.costEstimate = state.editBasicInfo.costEstimate;
            state.selectedItem.isCritical = state.editBasicInfo.isCritical;
            addHistory('Basic Info Updated', 'Defect information has been updated');
            await saveDefect();
            closeEditBasicInfoModal();
            alert('Basic info berhasil diupdate');
        }

        async function deleteDefect(id) {
            if (confirm('Apakah Anda yakin ingin menghapus defect ini?')) {
                const defect = state.defects.find(d => d.id === id);
                if (defect && defect.firebaseKey) {
                    await deleteDefectFromFirebase(defect.firebaseKey);
                    closeDetailModal();
                    alert('Defect berhasil dihapus');
                }
            }
        }

        async function deleteLetter(letterId) {
            if (confirm('Apakah Anda yakin ingin menghapus letter ini?')) {
                state.selectedItem.letters = state.selectedItem.letters.filter(l => l.id !== letterId);
                addHistory('Letter Deleted', 'Letter ID ' + letterId + ' dihapus');
                await saveDefect();
                renderWithScrollPreserve();
            }
        }

        async function deletePO(poId) {
            if (confirm('Apakah Anda yakin ingin menghapus PO ini?')) {
                state.selectedItem.pos = state.selectedItem.pos.filter(p => p.id !== poId);
                addHistory('PO Deleted', 'PO ID ' + poId + ' dihapus');
                await saveDefect();
                renderWithScrollPreserve();
            }
        }

        function updateNewDefect(field, value) { state.newDefect[field] = value; }
        
        function setResponsibility(resp) { 
            state.newDefect.responsibility = resp; 
            const contractorBtn = document.getElementById('resp-contractor-btn');
            const ownerBtn = document.getElementById('resp-owner-btn');
            if (contractorBtn && ownerBtn) {
                if (resp === 'Contractor') {
                    contractorBtn.className = 'p-6 border-2 rounded-lg transition border-orange-500 bg-orange-50';
                    ownerBtn.className = 'p-6 border-2 rounded-lg transition border-gray-300 hover:border-blue-300';
                } else {
                    contractorBtn.className = 'p-6 border-2 rounded-lg transition border-gray-300 hover:border-orange-300';
                    ownerBtn.className = 'p-6 border-2 rounded-lg transition border-blue-500 bg-blue-50';
                }
                const contractorField = document.getElementById('contractor-name-field');
                if (contractorField) contractorField.style.display = resp === 'Contractor' ? 'block' : 'none';
            }
        }

        async function addDefect() {
            if (!state.newDefect.title || !state.newDefect.equipment || !state.newDefect.responsibility) {
                alert('Mohon lengkapi Title, Equipment, dan pilih Responsibility');
                return;
            }
            const maxId = state.defects.reduce((max, d) => {
                const num = parseInt(d.id.split('-')[1]);
                return num > max ? num : max;
            }, 0);
            const newId = 'DD-' + String(maxId + 1).padStart(3, '0');
            const baseDefect = {
                ...state.newDefect, id: newId, status: 'Open', workProgress: 0, progressNotes: '',
                letters: [], pos: [], takeoverInitiated: false, coNegative: 0,
                contractServiceStages: getInitialContractServiceStages(),
                materialProcurementStages: getInitialMaterialProcurementStages(),
                history: [{ timestamp: new Date().toLocaleString('id-ID'), step: 'Defect Created', details: 'Responsibility: ' + state.newDefect.responsibility, user: state.currentUserName }]
            };
            if (state.newDefect.responsibility === 'Contractor') {
                baseDefect.currentStep = 'notify-contractor';
                baseDefect.completedSteps = [];
                baseDefect.contractorResponse = null;
                baseDefect.ownerAction = null;
                baseDefect.contractorName = 'JO (Joint Operation)';
            } else {
                baseDefect.currentStep = 'owner-action';
                baseDefect.completedSteps = [];
                baseDefect.contractorName = null;
                baseDefect.ownerAction = [];
            }
            await saveDefectToFirebase(baseDefect);

// ========== RESET FILTER ==========
state.filterStatus = 'all';
state.filterOwnership = 'all';
state.searchTerm = '';
state.activeTab = 'defects'; // Pindah ke tab Defects List
// ==================================

closeAddModal();
alert('Defect berhasil ditambahkan');
        }

        async function saveDefect() {
            await saveDefectToFirebase(state.selectedItem);
        }

        function addHistory(step, details) {
            state.selectedItem.history.push({
                timestamp: new Date().toLocaleString('id-ID'), step: step, details: details, user: state.currentUserName
            });
        }

        async function changeResponsibility(newResp) {
            const oldResp = state.selectedItem.responsibility;
            state.selectedItem.responsibility = newResp;
            if (newResp === 'Contractor') {
                state.selectedItem.currentStep = 'notify-contractor';
                state.selectedItem.completedSteps = [];
                state.selectedItem.contractorResponse = null;
                state.selectedItem.workProgress = 0;
                state.selectedItem.progressNotes = '';
            } else {
                state.selectedItem.currentStep = 'owner-action';
                state.selectedItem.completedSteps = [];
                state.selectedItem.ownerAction = [];
                state.selectedItem.workProgress = 0;
                state.selectedItem.progressNotes = '';
            }
            addHistory('Responsibility Changed', 'Changed from ' + oldResp + ' to ' + newResp);
            await saveDefect();
            closeEditResponsibilityModal();
            alert('Responsibility berhasil diubah ke ' + newResp);
        }

        async function unlockStep(stepName) {
            const stepIndex = state.selectedItem.completedSteps.indexOf(stepName);
            if (stepIndex > -1) {
                state.selectedItem.completedSteps.splice(stepIndex);
                state.selectedItem.currentStep = stepName;
                addHistory('Step Unlocked', 'Step "' + stepName + '" reopened for editing');
                await saveDefect();
                renderWithScrollPreserve();
            }
        }

        async function addLetter() {
            if (!state.newLetter.letterNo || !state.newLetter.subject) {
                alert('Mohon isi Letter No dan Subject');
                return;
            }
            let from, to;
            if (state.newLetter.type === 'Notification' || state.newLetter.type === 'Follow-up') {
                from = 'KPB (Owner)';
                to = 'JO (Joint Operation)';
            } else if (state.newLetter.type === 'Response' || state.newLetter.type === 'Rejection') {
                from = 'JO (Joint Operation)';
                to = 'KPB (Owner)';
            }
            const newId = state.selectedItem.letters.length + 1;
            state.selectedItem.letters.push({ 
                id: newId, date: state.newLetter.date, letterNo: state.newLetter.letterNo,
                from: from, to: to, subject: state.newLetter.subject, type: state.newLetter.type
            });
            addHistory('Letter Added', state.newLetter.type + ': ' + state.newLetter.letterNo);
            await saveDefect();
            closeAddLetterModal();
            alert('Letter berhasil ditambahkan');
        }

        async function addPO() {
            if (!state.newPO.poNumber || !state.newPO.vendor || !state.newPO.value) {
                alert('Mohon isi PO Number, Vendor, dan Value');
                return;
            }
            const newId = state.selectedItem.pos.length + 1;
            state.selectedItem.pos.push({ id: newId, ...state.newPO, date: new Date().toISOString().split('T')[0] });
            addHistory('PO Added', state.newPO.type + ': ' + state.newPO.poNumber + ' - ' + formatRupiah(state.newPO.value));
            await saveDefect();
            closeAddPOModal();
            alert('PO berhasil ditambahkan');
        }

        async function notifyContractor() {
            if (state.selectedItem.letters.length === 0) {
                alert('Mohon tambahkan minimal 1 notification letter');
                return;
            }
            state.selectedItem.status = 'In Progress';
            state.selectedItem.currentStep = 'contractor-response';
            state.selectedItem.completedSteps.push('notify-contractor');
            state.selectedItem.contractorName = 'JO (Joint Operation)';
            addHistory('Contractor Notified', state.selectedItem.letters.length + ' letter(s) sent to JO (Joint Operation)');
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function joProactiveRepair() {
    state.selectedItem.status = 'In Progress';
    state.selectedItem.contractorResponse = 'Accepted';
    state.selectedItem.currentStep = 'execution-progress';  // CHANGED from 'work-progress'
    state.selectedItem.completedSteps.push('notify-contractor', 'contractor-response');
    state.selectedItem.contractorName = 'JO (Joint Operation)';
    addHistory('JO Proactive Repair', 'JO detected issue and started repair proactively without Owner notification');
    await saveDefect();
    renderWithScrollPreserve();
    alert('Proactive repair by JO berhasil dicatat');
}

        async function contractorAccepted() {
    if (state.selectedItem.letters.filter(l => l.type === 'Response').length === 0) {
        alert('Mohon tambahkan response letter dari contractor');
        return;
    }
    if (state.selectedItem.takeoverInitiated) {
        state.selectedItem.takeoverInitiated = false;
        state.selectedItem.coNegative = 0;
        state.selectedItem.takeoverDate = null;
        state.selectedItem.takeoverBasisLetter = null;
        state.selectedItem.ownerAction = null;
        state.selectedItem.pos = [];
        const takeoverIndex = state.selectedItem.completedSteps.indexOf('takeover');
        if (takeoverIndex > -1) state.selectedItem.completedSteps.splice(takeoverIndex);
        const ownerActionIndex = state.selectedItem.completedSteps.indexOf('owner-action');
        if (ownerActionIndex > -1) state.selectedItem.completedSteps.splice(ownerActionIndex);
        const issuePoIndex = state.selectedItem.completedSteps.indexOf('issue-po');
        if (issuePoIndex > -1) state.selectedItem.completedSteps.splice(issuePoIndex);
        addHistory('Takeover Cancelled', 'Contractor accepted - Takeover removed');
    }
    state.selectedItem.contractorResponse = 'Accepted';
    state.selectedItem.currentStep = 'execution-progress';  // CHANGED from 'work-progress'
    state.selectedItem.completedSteps.push('contractor-response');
    addHistory('Contractor Accepted', 'Contractor will execute repair');
    await saveDefect();
    renderWithScrollPreserve();
}

        async function contractorRejected() {
            if (state.selectedItem.letters.filter(l => l.type === 'Rejection').length === 0) {
                alert('Mohon tambahkan rejection letter dari contractor');
                return;
            }
            state.selectedItem.contractorResponse = 'Rejected';
            state.selectedItem.currentStep = 'evidence-assessment';
            state.selectedItem.completedSteps.push('contractor-response');
            if (!state.selectedItem.evidenceAssessment) {
                state.selectedItem.evidenceAssessment = {
                    evidences: [], contractReview: '', technicalJustification: '',
                    thirdPartyAssessment: '', ownerDecision: null, decisionJustification: ''
                };
            }
            addHistory('Contractor Rejected', 'JO unable to execute repair - Evidence & Assessment required');
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function contractorNoResponse() {
            state.selectedItem.contractorResponse = 'No Response';
            state.selectedItem.currentStep = 'evidence-assessment';
            state.selectedItem.completedSteps.push('contractor-response');
            if (!state.selectedItem.evidenceAssessment) {
                state.selectedItem.evidenceAssessment = {
                    evidences: [], contractReview: '', technicalJustification: '',
                    thirdPartyAssessment: '', ownerDecision: null, decisionJustification: ''
                };
            }
            addHistory('Contractor No Response', 'JO tidak merespon - Evidence & Assessment required');
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function initiateTakeover() {
            const basisLetter = state.selectedItem.letters.find(l => l.type === 'Rejection');
            const evidenceCount = state.selectedItem.evidenceAssessment ? state.selectedItem.evidenceAssessment.evidences.length : 0;
            state.selectedItem.takeoverInitiated = true;
            state.selectedItem.coNegative = state.selectedItem.costEstimate;
            state.selectedItem.takeoverDate = new Date().toISOString().split('T')[0];
            state.selectedItem.takeoverBasisLetter = basisLetter ? basisLetter.letterNo : '';
            state.selectedItem.currentStep = 'owner-action';
            state.selectedItem.completedSteps.push('takeover');
            addHistory('Takeover Initiated', 'CO Negatif ' + formatRupiah(state.selectedItem.costEstimate) + ' | Evidence: ' + evidenceCount + ' items documented');
            await saveDefect();
            renderWithScrollPreserve();
        }

        function setOwnerAction(action) {
    if (!state.selectedItem.ownerAction) state.selectedItem.ownerAction = [];
    const index = state.selectedItem.ownerAction.indexOf(action);
    if (index > -1) {
        state.selectedItem.ownerAction.splice(index, 1);
    } else {
        state.selectedItem.ownerAction.push(action);
    }
    renderWithScrollPreserve();  
}

        async function confirmOwnerAction() {
            if (!state.selectedItem.ownerAction || state.selectedItem.ownerAction.length === 0) {
                alert('Mohon pilih minimal 1 Owner Action');
                return;
            }
            if (state.selectedItem.ownerAction.includes('Self Repair') && !state.selectedItem.selfRepairExecutor) {
                alert('Mohon isi nama pelaksana untuk Self Repair');
                return;
            }
            const onlySelfRepair = state.selectedItem.ownerAction.length === 1 && state.selectedItem.ownerAction[0] === 'Self Repair';
            if (onlySelfRepair) {
    state.selectedItem.currentStep = 'execution-progress';
    state.selectedItem.status = 'In Progress';
    state.selectedItem.completedSteps.push('owner-action');
} else {
    state.selectedItem.currentStep = 'proses-kontrak';
    state.selectedItem.completedSteps.push('owner-action');
}
            addHistory('Owner Action Selected', 'Selected: ' + state.selectedItem.ownerAction.join(', ') + 
                (state.selectedItem.selfRepairExecutor ? ' | Self Repair oleh: ' + state.selectedItem.selfRepairExecutor : ''));
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function confirmProsesKontrak() {
    // VALIDASI: Cek apakah ada Contract Service atau Material Procurement
    const needsPO = state.selectedItem.ownerAction && 
                    (state.selectedItem.ownerAction.includes('Contract Service') || 
                     state.selectedItem.ownerAction.includes('Material Procurement'));
    
    // Jika butuh PO tapi belum ada, BLOCK
    if (needsPO && state.selectedItem.pos.length === 0) {
        alert('⚠️ Mohon tambahkan minimal 1 PO!\n\nContract Service dan Material Procurement memerlukan PO untuk dapat melanjutkan ke tahap eksekusi.');
        return; // STOP di sini
    }
    
    // Jika validasi pass, lanjutkan
    state.selectedItem.currentStep = 'execution-progress';
    state.selectedItem.status = 'In Progress';
    state.selectedItem.completedSteps.push('proses-kontrak');
    addHistory('Proses Kontrak Confirmed', 'Moving to execution with ' + state.selectedItem.pos.length + ' PO(s)');
    await saveDefect();
    renderWithScrollPreserve();
}

        async function updateProgress(value) {
            state.selectedItem.workProgress = parseInt(value);
            await saveDefect();
            renderWithScrollPreserve();
        }

        async function updateProgressNotes(notes) {
            state.selectedItem.progressNotes = notes;
            addHistory('Progress Notes Updated', 'Progress notes updated');
            await saveDefect();
        }

        async function markClosed() {
            state.selectedItem.status = 'Closed';
            state.selectedItem.currentStep = 'completed';
            state.selectedItem.completedSteps.push('completed');
            addHistory('Defect Closed', 'Repair work completed');
            await saveDefect();
            renderWithScrollPreserve();
        }

        function getStepStatus(defect, stepName) {
    if (!defect.completedSteps) defect.completedSteps = [];
    if (defect.completedSteps.includes(stepName)) return 'completed';
    if (defect.currentStep === stepName) return 'current';
    return 'pending';
}

function renderProgressBar(defect) {
    const steps = [];
    if (defect.responsibility === 'Contractor') {
        steps.push({ name: 'notify-contractor', label: 'Notify Contractor' }, 
                   { name: 'contractor-response', label: 'Contractor Response' });
        if (defect.contractorResponse === 'Rejected' || defect.contractorResponse === 'No Response') {
            steps.push({ name: 'evidence-assessment', label: 'Evidence & Assessment' });
            if (defect.evidenceAssessment && defect.evidenceAssessment.ownerDecision === 'force-co-negative') {
                steps.push({ name: 'takeover', label: 'Takeover' }, 
                          { name: 'owner-action', label: 'Owner Action' });
                const onlySelfRepair = defect.ownerAction && defect.ownerAction.length === 1 && defect.ownerAction[0] === 'Self Repair';
                if (!onlySelfRepair) {
                    steps.push({ name: 'proses-kontrak', label: 'Proses Kontrak' });  // CHANGED from 'issue-po'
                }
            }
        }
        steps.push({ name: 'execution-progress', label: 'Execution Progress' });
    } else {
        steps.push({ name: 'owner-action', label: 'Owner Action' });
        const onlySelfRepair = defect.ownerAction && defect.ownerAction.length === 1 && defect.ownerAction[0] === 'Self Repair';
        if (!onlySelfRepair) steps.push({ name: 'proses-kontrak', label: 'Proses Kontrak' });
        steps.push({ name: 'execution-progress', label: 'Execution Progress' });
    }
            return '<div class="mb-6"><div class="flex items-center justify-between">' + steps.map((step, index) => {
                const status = getStepStatus(defect, step.name);
                return '<div class="flex-1 ' + (index > 0 ? 'ml-2' : '') + '"><div class="relative">' +
                    (index > 0 ? '<div class="absolute top-5 left-0 w-full h-1 ' + (status === 'completed' ? 'bg-green-500' : 'bg-gray-300') + '" style="transform: translateX(-50%); width: calc(100% + 0.5rem);"></div>' : '') +
                    '<div class="relative flex flex-col items-center"><div class="w-10 h-10 rounded-full flex items-center justify-center ' +
                    (status === 'completed' ? 'bg-green-500 text-white' : status === 'current' ? 'bg-blue-500 text-white animate-pulse' : 'bg-gray-300 text-gray-600') +
                    ' font-bold text-sm z-10">' + (status === 'completed' ? '✓' : index + 1) + '</div>' +
                    '<div class="text-xs font-semibold mt-2 text-center ' + (status === 'current' ? 'text-blue-600' : 'text-gray-600') + '">' + step.label + '</div></div></div></div>';
            }).join('') + '</div></div>';
        }

        function createCharts() {
            setTimeout(() => {
                const stats = getStats();
                const ctx1 = document.getElementById('statusChart');
                if (ctx1) {
                    if (ctx1.chart) ctx1.chart.destroy();
                    ctx1.chart = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['Open', 'In Progress', 'Closed'],
                            datasets: [{ data: [stats.open, stats.inProgress, stats.closed], backgroundColor: ['#ef4444', '#eab308', '#22c55e'], borderWidth: 2, borderColor: '#fff' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
                const ctx2 = document.getElementById('responsibilityChart');
                if (ctx2) {
                    if (ctx2.chart) ctx2.chart.destroy();
                    const contractor = state.defects.filter(d => d.responsibility === 'Contractor').length;
                    const owner = state.defects.filter(d => d.responsibility === 'Owner').length;
                    ctx2.chart = new Chart(ctx2, {
                        type: 'pie',
                        data: {
                            labels: ['Contractor', 'Owner'],
                            datasets: [{ data: [contractor, owner], backgroundColor: ['#f97316', '#3b82f6'], borderWidth: 2, borderColor: '#fff' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
                const ctx3 = document.getElementById('phaseChart');
                if (ctx3) {
                    if (ctx3.chart) ctx3.chart.destroy();
                    ctx3.chart = new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(stats.byPhase).map(p => p.toUpperCase()),
                            datasets: [{ label: 'Defects', data: Object.values(stats.byPhase), backgroundColor: '#8b5cf6', borderRadius: 6 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                }
            }, 100);
        }

        function renderDashboard() {
    const stats = getStats();
    createCharts();
    const criticalDefects = state.defects.filter(d => d.isCritical && d.status !== 'Closed');
    
    return '<div class="space-y-6">' +
    // Main Statistics - NEW COLORS
    '<div class="grid grid-cols-4 gap-6">' +
        // Total - Dark theme
        '<div class="bg-gradient-to-br from-slate-700 to-slate-900 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300 border border-slate-600">' +
        '<div class="flex items-center justify-between mb-3">' +
        '<div class="text-sm font-bold opacity-90 uppercase tracking-wide">Total Defects</div>' +
        '<svg class="w-8 h-8 opacity-80" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>' +
        '</div>' +
        '<div class="text-6xl font-black mb-2">' + stats.total + '</div>' +
        '<div class="text-sm opacity-80 flex items-center gap-2">' +
        '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>' +
        'Avg Progress: ' + stats.avgProgress + '%</div></div>' +
        
        // Open - GRAY
        '<div class="bg-gradient-to-br from-gray-500 to-gray-700 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300 border border-gray-400">' +
        '<div class="flex items-center justify-between mb-3">' +
        '<div class="text-sm font-bold opacity-90 uppercase tracking-wide">Open</div>' +
        '<svg class="w-8 h-8 opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' +
        '</div>' +
        '<div class="text-6xl font-black">' + stats.open + '</div>' +
        '<div class="text-sm opacity-80 mt-2">Awaiting Action</div></div>' +
        
        // In Progress - GREEN
        '<div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300 border border-green-400">' +
        '<div class="flex items-center justify-between mb-3">' +
        '<div class="text-sm font-bold opacity-90 uppercase tracking-wide">In Progress</div>' +
        '<svg class="w-8 h-8 opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>' +
        '</div>' +
        '<div class="text-6xl font-black">' + stats.inProgress + '</div>' +
        '<div class="text-sm opacity-80 mt-2">Active Work</div></div>' +
        
        // Closed - BLUE
        '<div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300 border border-blue-400">' +
        '<div class="flex items-center justify-between mb-3">' +
        '<div class="text-sm font-bold opacity-90 uppercase tracking-wide">Closed</div>' +
        '<svg class="w-8 h-8 opacity-80" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' +
        '</div>' +
        '<div class="text-6xl font-black">' + stats.closed + '</div>' +
        '<div class="text-sm opacity-80 mt-2">Completed</div></div>' +
        '</div>' +
        
        // Ownership Statistics
        '<div class="grid grid-cols-3 gap-6">' +
        // Takeover
        '<div class="bg-gradient-to-br from-rose-500 to-rose-700 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300">' +
        '<div class="flex items-center gap-3 mb-3">' +
        '<div class="p-3 bg-white bg-opacity-20 rounded-lg backdrop-blur-sm">' +
        '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>' +
        '</div>' +
        '<div><div class="text-xs font-semibold opacity-90 uppercase tracking-wide">Takeover from JO</div></div>' +
        '</div>' +
        '<div class="text-5xl font-black mb-3">' + stats.takeoverCount + '</div>' +
        '<div class="bg-white bg-opacity-20 rounded-lg p-3 backdrop-blur-sm">' +
        '<div class="text-xs opacity-90 uppercase tracking-wide mb-1">Total CO Negatif</div>' +
        '<div class="text-2xl font-bold">' + formatRupiah(stats.totalCONegative) + '</div></div></div>' +
        
        // KPB Original
        '<div class="bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300">' +
        '<div class="flex items-center gap-3 mb-3">' +
        '<div class="p-3 bg-white bg-opacity-20 rounded-lg backdrop-blur-sm">' +
        '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/></svg>' +
        '</div>' +
        '<div><div class="text-xs font-semibold opacity-90 uppercase tracking-wide">KPB Original</div></div>' +
        '</div>' +
        '<div class="text-5xl font-black mb-3">' + stats.ownerOriginal + '</div>' +
        '<div class="text-sm opacity-90">Root Cause Owner</div></div>' +
        
        // JO Responsibility
        '<div class="bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-all duration-300">' +
        '<div class="flex items-center gap-3 mb-3">' +
        '<div class="p-3 bg-white bg-opacity-20 rounded-lg backdrop-blur-sm">' +
        '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/></svg>' +
        '</div>' +
        '<div><div class="text-xs font-semibold opacity-90 uppercase tracking-wide">JO Responsibility</div></div>' +
        '</div>' +
        '<div class="text-5xl font-black mb-3">' + state.defects.filter(d => d.responsibility === 'Contractor' && !d.takeoverInitiated).length + '</div>' +
        '<div class="text-sm opacity-90">Contractor Handling</div></div>' +
        '</div>' +
        
        // Charts Section - Enhanced Design
        '<div class="grid grid-cols-3 gap-6">' +
        '<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">' +
        '<div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">' +
        '<h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">' +
        '<svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/></svg>' +
        'Status Distribution</h3></div>' +
        '<div class="p-6"><canvas id="statusChart" height="200"></canvas></div></div>' +
        
        '<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">' +
        '<div class="px-6 py-4 bg-gradient-to-r from-orange-50 to-orange-100 border-b border-orange-200">' +
        '<h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">' +
        '<svg class="w-5 h-5 text-orange-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>' +
        'By Responsibility</h3></div>' +
        '<div class="p-6"><canvas id="responsibilityChart" height="200"></canvas></div></div>' +
        
        '<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">' +
        '<div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-purple-100 border-b border-purple-200">' +
        '<h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">' +
        '<svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>' +
        'By Phase</h3></div>' +
        '<div class="p-6"><canvas id="phaseChart" height="200"></canvas></div></div>' +
        '</div>' +
        
        // Critical Items Alert
        (criticalDefects.length > 0 ? 
        '<div class="bg-white rounded-2xl shadow-xl border-2 border-red-500 overflow-hidden">' +
        '<div class="px-6 py-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200 flex items-center gap-3">' +
        '<div class="p-2 bg-red-500 rounded-lg">' +
        '<svg class="w-6 h-6 text-white animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' +
        '</div>' +
        '<h3 class="text-lg font-bold text-red-800 flex-1">⚠️ Critical Items Requiring Immediate Attention</h3>' +
        '<span class="px-4 py-2 bg-red-500 text-white rounded-full font-bold text-sm">' + criticalDefects.length + ' Critical</span>' +
        '</div>' +
        '<div class="p-6"><div class="space-y-3">' +
        criticalDefects.map(d => 
        '<div class="flex justify-between items-center p-4 bg-gradient-to-r from-red-50 to-orange-50 rounded-xl border-2 border-red-300 hover:shadow-lg transition-all duration-200">' +
        '<div class="flex-1">' +
        '<div class="flex items-center gap-3 mb-2">' +
        '<span class="text-red-600 font-bold text-xl">⚠️</span>' +
        '<span class="font-bold text-base text-gray-900">' + d.id + ' - ' + d.title + '</span>' +
        '<span class="px-3 py-1 text-xs font-bold rounded-full ' + 
        (d.status === 'Open' ? 'bg-gray-600 text-white' : 'bg-green-600 text-white') + '">' + d.status + '</span>' +
        '</div>' +
        '<div class="grid grid-cols-3 gap-4 text-xs text-gray-600">' +
        '<div><span class="font-semibold">Equipment:</span> ' + d.equipment + '</div>' +
        '<div><span class="font-semibold">Location:</span> ' + d.location + '</div>' +
        '<div><span class="font-semibold">Target:</span> ' + d.targetDate + '</div>' +
        '</div></div>' +
        '<button onclick="openDetailModal(\'' + d.id + '\')" class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-bold text-sm shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">' +
        '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>' +
        'Manage</button></div>'
        ).join('') +
        '</div></div></div>' : '') +
        '</div>';
}

        function renderDefectsList() {
            const filtered = getFilteredDefects();
            return '<div class="space-y-6">' +
                '<div class="bg-white rounded-lg shadow-sm border p-6"><div class="flex gap-4">' +
                '<input type="text" placeholder="Search by ID, Title, or Equipment..." value="' + state.searchTerm + '" oninput="setSearchTerm(this.value)" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">' +
                '<select onchange="setFilter(this.value)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
'<option value="all" ' + (state.filterStatus === 'all' ? 'selected' : '') + '>All Status</option>' +
'<option value="Open" ' + (state.filterStatus === 'Open' ? 'selected' : '') + '>Open</option>' +
'<option value="In Progress" ' + (state.filterStatus === 'In Progress' ? 'selected' : '') + '>In Progress</option>' +
'<option value="Closed" ' + (state.filterStatus === 'Closed' ? 'selected' : '') + '>Closed</option></select>' +
                '<select onchange="setOwnershipFilter(this.value)" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
'<option value="all" ' + (state.filterOwnership === 'all' ? 'selected' : '') + '>All Ownership</option>' +
'<option value="contractor" ' + (state.filterOwnership === 'contractor' ? 'selected' : '') + '>JO Responsibility</option>' +
'<option value="owner-original" ' + (state.filterOwnership === 'owner-original' ? 'selected' : '') + '>KPB Original</option>' +
'<option value="takeover" ' + (state.filterOwnership === 'takeover' ? 'selected' : '') + '>Takeover from JO</option></select>' +
                '<button onclick="openAddModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium whitespace-nowrap">Add Defect</button>' +
                '<div class="relative"><button onclick="document.getElementById(\'exportMenu\').classList.toggle(\'hidden\')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium whitespace-nowrap flex items-center gap-2">' +
                '<span>Export</span><span>▼</span></button>' +
                '<div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border z-10">' +
                '<button onclick="exportToExcel()" class="w-full px-4 py-3 text-left hover:bg-gray-100 font-medium text-gray-700 border-b">Export to Excel</button>' +
                '<button onclick="exportToPDF()" class="w-full px-4 py-3 text-left hover:bg-gray-100 font-medium text-gray-700">Export to PDF</button>' +
                '</div></div></div></div>' +
                '<div class="bg-white rounded-lg shadow-sm border"><div class="px-6 py-4 border-b bg-gray-50"><div class="text-sm font-semibold text-gray-700">Showing ' + filtered.length + ' of ' + state.defects.length + ' defects</div></div>' +
                '<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Title</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Equipment</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Discipline</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Phase</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Ownership</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Progress</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>' +
                '<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Action</th></tr></thead><tbody class="divide-y">' +
                filtered.map(d => '<tr class="hover:bg-gray-50 ' + (d.isCritical ? 'bg-red-50' : '') + '">' +
                    '<td class="px-6 py-4 font-mono text-sm font-semibold text-blue-600">' + (d.isCritical ? '<span class="text-red-600">⚠️ </span>' : '') + d.id + '</td>' +
                    '<td class="px-6 py-4"><div class="font-medium text-gray-900">' + d.title + '</div><div class="text-sm text-gray-500">' + d.location + '</div></td>' +
                    '<td class="px-6 py-4 text-sm">' + d.equipment + '</td>' +
                    '<td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded bg-purple-100 text-purple-800">' + (d.discipline || 'N/A') + '</span></td>' +
                    '<td class="px-6 py-4 text-sm uppercase">' + d.phase + '</td>' +
                    '<td class="px-6 py-4">' + 
                    (d.takeoverInitiated ? 
                        '<div><span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">🔄 Takeover</span>' +
                        '<div class="text-xs text-red-600 font-semibold mt-1">CO: ' + formatRupiah(d.coNegative) + '</div></div>' :
                        '<span class="px-3 py-1 text-xs font-semibold rounded-full ' + 
                        (d.responsibility === 'Contractor' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800') + '">' + 
                        (d.responsibility === 'Contractor' ? 'JO' : 'KPB Original') + '</span>') +
                    '</td>' +
                    '<td class="px-6 py-4"><div class="flex items-center gap-2"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full" style="width: ' + (d.workProgress || 0) + '%"></div></div><span class="text-xs font-semibold text-gray-600">' + (d.workProgress || 0) + '%</span></div></td>' +
                    '<td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold rounded-full ' + (d.status === 'Open' ? 'bg-red-100 text-red-800' : d.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800') + '">' + d.status + '</span></td>' +
                    '<td class="px-6 py-4"><div class="flex gap-2"><button onclick="openDetailModal(\'' + d.id + '\')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-xs shadow-sm">Manage</button>' +
                    '<button onclick="deleteDefect(\'' + d.id + '\')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium text-xs shadow-sm">Delete</button></div></td></tr>'
                ).join('') + '</tbody></table></div></div></div>';
        }

        function exportToExcel() {
    const filtered = getFilteredDefects();
    
    // Create BOM for UTF-8 Excel compatibility
    const BOM = '\uFEFF';
    
    // Header dengan formatting lebih baik
    let csv = 'D&D MANAGEMENT SYSTEM - DEFECT REPORT\n';
    csv += 'Generated: ' + new Date().toLocaleString('id-ID') + '\n';
    csv += 'Total Records: ' + filtered.length + '\n\n';
    
    // Column headers
    csv += 'ID,Title,Equipment,Discipline,Phase,Location,Ownership Type,Status,Progress (%),Cost Estimate (Rp),CO Negative (Rp),Defect Date,Target Date,Reported By,Description,Root Cause\n';
    
    // Data rows
    filtered.forEach(d => {
        const ownership = d.takeoverInitiated ? 'Takeover from JO' : (d.responsibility === 'Contractor' ? 'JO Responsibility' : 'KPB Original');
        const coNegative = d.takeoverInitiated ? d.coNegative : 0;
        csv += '"' + d.id + '",';
        csv += '"' + d.title.replace(/"/g, '""') + '",';
        csv += '"' + d.equipment + '",';
        csv += '"' + (d.discipline || 'N/A') + '",';
        csv += '"' + d.phase.toUpperCase() + '",';
        csv += '"' + d.location + '",';
        csv += '"' + ownership + '",';
        csv += '"' + d.status + '",';
        csv += (d.workProgress || 0) + ',';
        csv += d.costEstimate + ',';
        csv += coNegative + ',';
        csv += '"' + d.defectDate + '",';
        csv += '"' + d.targetDate + '",';
        csv += '"' + d.reportedBy + '",';
        csv += '"' + (d.description || '').replace(/"/g, '""') + '",';
        csv += '"' + (d.rootCause || '').replace(/"/g, '""') + '"\n';
    });
    
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'DD_Report_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
    document.getElementById('exportMenu').classList.add('hidden');
    alert('Excel file downloaded! File sudah dalam format yang rapi dan siap dibuka di Excel/Google Sheets.');
}

function exportToPDF() {
    const filtered = getFilteredDefects();
    const stats = getStats();
    
    // Create print-friendly HTML
    let printHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
    printHTML += '<title>D&D Management Report</title>';
    printHTML += '<style>';
    printHTML += 'body { font-family: Arial, sans-serif; margin: 20px; color: #000; }';
    printHTML += 'h1 { color: #1e40af; border-bottom: 3px solid #1e40af; padding-bottom: 10px; }';
    printHTML += 'h2 { color: #374151; margin-top: 30px; }';
    printHTML += '.header-info { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0; }';
    printHTML += '.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }';
    printHTML += '.stat-card { background: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb; }';
    printHTML += '.stat-label { font-size: 12px; color: #6b7280; font-weight: bold; }';
    printHTML += '.stat-value { font-size: 28px; font-weight: bold; color: #1e40af; }';
    printHTML += 'table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 11px; }';
    printHTML += 'th { background: #1e40af; color: white; padding: 12px 8px; text-align: left; font-weight: bold; }';
    printHTML += 'td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; }';
    printHTML += 'tr:nth-child(even) { background: #f9fafb; }';
    printHTML += 'tr:hover { background: #f3f4f6; }';
    printHTML += '.status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; display: inline-block; }';
    printHTML += '.status-open { background: #fee2e2; color: #991b1b; }';
    printHTML += '.status-progress { background: #fef3c7; color: #92400e; }';
    printHTML += '.status-closed { background: #d1fae5; color: #065f46; }';
    printHTML += '.ownership-jo { background: #fed7aa; color: #9a3412; }';
    printHTML += '.ownership-kpb { background: #dbeafe; color: #1e40af; }';
    printHTML += '.ownership-takeover { background: #fecaca; color: #991b1b; }';
    printHTML += '.critical-marker { color: #dc2626; font-weight: bold; }';
    printHTML += '.footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px; }';
    printHTML += '@media print { body { margin: 0; } .no-print { display: none; } }';
    printHTML += '</style></head><body>';
    
    // Header
    printHTML += '<h1>D&D MANAGEMENT SYSTEM - DEFECT REPORT</h1>';
    printHTML += '<div class="header-info">';
    printHTML += '<div><strong>Report Generated:</strong> ' + new Date().toLocaleString('id-ID') + '</div>';
    printHTML += '<div><strong>Total Records:</strong> ' + filtered.length + ' defects</div>';
    printHTML += '<div><strong>Filters Applied:</strong> ';
    if (state.filterStatus !== 'all') printHTML += 'Status=' + state.filterStatus + ' ';
    if (state.filterOwnership !== 'all') printHTML += 'Ownership=' + state.filterOwnership + ' ';
    if (state.searchTerm) printHTML += 'Search="' + state.searchTerm + '"';
    if (state.filterStatus === 'all' && state.filterOwnership === 'all' && !state.searchTerm) printHTML += 'None (All data)';
    printHTML += '</div></div>';
    
    // Statistics Summary
    printHTML += '<h2>Summary Statistics</h2>';
    printHTML += '<div class="stats-grid">';
    printHTML += '<div class="stat-card"><div class="stat-label">TOTAL DEFECTS</div><div class="stat-value">' + stats.total + '</div></div>';
    printHTML += '<div class="stat-card"><div class="stat-label">IN PROGRESS</div><div class="stat-value">' + stats.inProgress + '</div></div>';
    printHTML += '<div class="stat-card"><div class="stat-label">TAKEOVER</div><div class="stat-value">' + stats.takeoverCount + '</div></div>';
    printHTML += '<div class="stat-card"><div class="stat-label">CO NEGATIVE</div><div class="stat-value">' + formatRupiah(stats.totalCONegative) + '</div></div>';
    printHTML += '</div>';
    
    // Table
    printHTML += '<h2>Defect Details</h2>';
    printHTML += '<table><thead><tr>';
    printHTML += '<th>ID</th><th>Title</th><th>Equipment</th><th>Discipline</th><th>Phase</th>';
    printHTML += '<th>Location</th><th>Ownership</th><th>Status</th><th>Progress</th>';
    printHTML += '<th>Cost Est.</th><th>Target Date</th></tr></thead><tbody>';
    
    filtered.forEach(d => {
        const statusClass = d.status === 'Open' ? 'status-open' : d.status === 'In Progress' ? 'status-progress' : 'status-closed';
        const ownershipText = d.takeoverInitiated ? 'Takeover' : (d.responsibility === 'Contractor' ? 'JO' : 'KPB');
        const ownershipClass = d.takeoverInitiated ? 'ownership-takeover' : (d.responsibility === 'Contractor' ? 'ownership-jo' : 'ownership-kpb');
        
        printHTML += '<tr>';
        printHTML += '<td><strong>' + (d.isCritical ? '<span class="critical-marker">⚠️ </span>' : '') + d.id + '</strong></td>';
        printHTML += '<td>' + d.title + '</td>';
        printHTML += '<td>' + d.equipment + '</td>';
        printHTML += '<td>' + (d.discipline || 'N/A') + '</td>';
        printHTML += '<td>' + d.phase.toUpperCase() + '</td>';
        printHTML += '<td>' + d.location + '</td>';
        printHTML += '<td><span class="status-badge ' + ownershipClass + '">' + ownershipText + '</span>';
        if (d.takeoverInitiated) printHTML += '<br><small>' + formatRupiah(d.coNegative) + '</small>';
        printHTML += '</td>';
        printHTML += '<td><span class="status-badge ' + statusClass + '">' + d.status + '</span></td>';
        printHTML += '<td><strong>' + (d.workProgress || 0) + '%</strong></td>';
        printHTML += '<td>' + formatRupiah(d.costEstimate) + '</td>';
        printHTML += '<td>' + d.targetDate + '</td>';
        printHTML += '</tr>';
    });
    
    printHTML += '</tbody></table>';
    
    // Footer
    printHTML += '<div class="footer">';
    printHTML += '<div><strong>D&D Management System</strong></div>';
    printHTML += '<div>Developed by TS-KPB © 2025</div>';
    printHTML += '</div>';
    
    printHTML += '<div class="no-print" style="position: fixed; top: 20px; right: 20px; background: #1e40af; color: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">';
    printHTML += '<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Ready to Save as PDF</div>';
    printHTML += '<div style="font-size: 13px;">Press <strong>Ctrl+P</strong> (Windows) or <strong>Cmd+P</strong> (Mac)</div>';
    printHTML += '<div style="font-size: 13px;">Then select "Save as PDF"</div>';
    printHTML += '<button onclick="window.print()" style="margin-top: 10px; width: 100%; padding: 8px; background: white; color: #1e40af; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Print Now</button>';
    printHTML += '</div>';
    
    printHTML += '</body></html>';
    
    // Open in new window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHTML);
    printWindow.document.close();
    
    // Auto-trigger print dialog after content loads
    setTimeout(() => {
        printWindow.print();
    }, 500);
    
    document.getElementById('exportMenu').classList.add('hidden');
}
            

        function renderAddModal() {
            if (!state.showAddModal) return '';
            return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                '<div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">' +
                '<div class="px-6 py-4 bg-blue-600 text-white"><div class="text-xl font-bold">Add New Defect</div></div>' +
                '<div class="p-6 space-y-6"><div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Title</label><input type="text" onchange="updateNewDefect(\'title\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Equipment</label><input type="text" onchange="updateNewDefect(\'equipment\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
'<div class="col-span-2"><label class="block text-sm font-semibold mb-1 text-gray-700">Unit Description</label>' +
        '<select onchange="updateNewDefect(\'unitDescription\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
        '<option value="">-- Select Unit --</option>' +
        UNIT_OPTIONS.map(unit => '<option value="' + unit + '">' + unit + '</option>').join('') +
        '</select></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Location</label><input type="text" onchange="updateNewDefect(\'location\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Phase</label><select onchange="updateNewDefect(\'phase\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
                '<option value="commissioning">Commissioning</option><option value="startup">Start-Up</option><option value="oa">OA</option><option value="fa">FA</option><option value="warranty">Warranty</option></select></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Discipline</label><select onchange="updateNewDefect(\'discipline\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
                '<option value="Static">Static</option><option value="Rotating">Rotating</option><option value="Electrical">Electrical</option><option value="Instrument">Instrument</option></select></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Defect Date</label><input type="date" onchange="updateNewDefect(\'defectDate\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Target Date</label><input type="date" onchange="updateNewDefect(\'targetDate\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Reported By</label><input type="text" onchange="updateNewDefect(\'reportedBy\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
                '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Cost Estimate (Rp)</label><input type="number" onchange="updateNewDefect(\'costEstimate\', parseInt(this.value) || 0)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>' +
                '<div class="col-span-2"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" onchange="updateNewDefect(\'isCritical\', this.checked)" class="w-5 h-5 rounded border-gray-300 text-red-600 focus:ring-red-500"><span class="text-sm font-semibold text-gray-700">⚠️ Mark as CRITICAL (perhatian khusus)</span></label></div>' +
                '<div class="col-span-2"><label class="block text-sm font-semibold mb-1 text-gray-700">Description</label><textarea onchange="updateNewDefect(\'description\', this.value)" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea></div>' +
                '<div class="col-span-2"><label class="block text-sm font-semibold mb-1 text-gray-700">Root Cause</label><textarea onchange="updateNewDefect(\'rootCause\', this.value)" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea></div></div>' +
                '<div class="border-t pt-6"><div class="text-lg font-bold mb-4 text-gray-900">Select Responsibility</div><div class="grid grid-cols-2 gap-4">' +
                '<button id="resp-contractor-btn" onclick="setResponsibility(\'Contractor\')" type="button" class="p-6 border-2 rounded-lg transition ' + (state.newDefect.responsibility === 'Contractor' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:border-orange-300') + '">' +
                '<div class="text-xl font-bold mb-2">JO (Contractor)</div><div class="text-sm text-gray-600">Defect tanggung jawab Joint Operation / Contractor</div></button>' +
                '<button id="resp-owner-btn" onclick="setResponsibility(\'Owner\')" type="button" class="p-6 border-2 rounded-lg transition ' + (state.newDefect.responsibility === 'Owner' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300') + '">' +
                '<div class="text-xl font-bold mb-2">KPB (Owner)</div><div class="text-sm text-gray-600">Defect tanggung jawab KPB / Owner</div></button></div></div>' +
                '<div id="contractor-name-field" class="border rounded-lg p-4 bg-orange-50 border-orange-200" style="display: ' + (state.newDefect.responsibility === 'Contractor' ? 'block' : 'none') + '">' +
                '<label class="block text-xs font-semibold mb-1 text-gray-700">Contractor</label>' +
                '<div class="text-lg font-bold text-orange-900">JO (Joint Operation)</div>' +
                '<div class="text-xs text-gray-600 mt-1">Contractor fixed untuk semua defect tanggung jawab JO</div></div>' +
                '</div><div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50">' +
                '<button onclick="closeAddModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">Cancel</button>' +
                '<button onclick="addDefect()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Create Defect</button></div></div></div>';
        }

        function renderDetailModal() {
            if (!state.showDetailModal || !state.selectedItem) return '';
            const d = state.selectedItem;
            return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">' +
                '<div class="bg-white rounded-lg max-w-6xl w-full my-8 max-h-[95vh] overflow-y-auto">' +
                '<div class="px-6 py-5 bg-gradient-to-r from-blue-600 to-blue-700 text-white sticky top-0 z-10 rounded-t-lg">' +
                '<div class="flex justify-between items-start"><div><div class="text-2xl font-bold">' + d.id + '</div><div class="text-lg mt-1">' + d.title + '</div>' +
                '<div class="text-blue-100 text-sm mt-1">' + d.equipment + ' | ' + d.location + '</div></div>' +
                '<button onclick="closeDetailModal()" class="text-white hover:bg-blue-600 px-3 py-1 rounded font-medium">Close</button></div>' +
                '<div class="flex gap-3 mt-4"><span class="px-3 py-1 bg-white rounded-full text-sm font-semibold ' + 
                (d.status === 'Open' ? 'text-red-800' : d.status === 'In Progress' ? 'text-yellow-800' : 'text-green-800') + '">' + d.status + '</span>' +
                '<span class="px-3 py-1 bg-white rounded-full text-sm font-semibold ' + (d.responsibility === 'Contractor' ? 'text-orange-800' : 'text-blue-800') + '">' + (d.responsibility === 'Contractor' ? 'JO' : 'KPB') + '</span>' +
                '<button onclick="openEditResponsibilityModal()" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 rounded-full text-sm font-semibold text-white">Change Responsibility</button>' +
                '<button onclick="openEditBasicInfoModal()" class="px-3 py-1 bg-green-500 hover:bg-green-600 rounded-full text-sm font-semibold text-white">Edit Basic Info</button></div></div>' +
                '<div class="p-6 space-y-6"><div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-6 border">' +
                '<div class="text-sm font-bold text-gray-700 mb-4 uppercase">Process Flow</div>' + renderProgressBar(d) + '</div>' +
                '<div class="grid grid-cols-2 gap-4"><div class="border rounded-lg p-4"><div class="text-xs font-semibold text-gray-500 uppercase mb-2">Description</div><div class="text-sm text-gray-800">' + d.description + '</div></div>' +
                '<div class="border rounded-lg p-4 bg-red-50"><div class="text-xs font-semibold text-red-700 uppercase mb-2">Root Cause</div><div class="text-sm text-gray-800">' + d.rootCause + '</div></div></div>' +
                '<div class="grid grid-cols-4 gap-4 text-sm"><div><div class="text-gray-600 mb-1">Defect Date</div><div class="font-semibold">' + d.defectDate + '</div></div>' +
                '<div><div class="text-gray-600 mb-1">Target Date</div><div class="font-semibold">' + d.targetDate + '</div></div>' +
                '<div><div class="text-gray-600 mb-1">Cost Estimate</div><div class="font-semibold text-blue-700">' + formatRupiah(d.costEstimate) + '</div></div>' +
                '<div><div class="text-gray-600 mb-1">Reported By</div><div class="font-semibold">' + d.reportedBy + '</div></div></div>' +
                renderWorkflowSection(d) +
                '<div class="border rounded-lg"><div class="px-4 py-3 bg-gray-50 border-b font-semibold text-gray-900">History Timeline</div>' +
                '<div class="p-4">' +
                (d.history && d.history.length > 0 ? '<div class="space-y-3">' +
                d.history.slice().reverse().map((h, index) => '<div class="flex gap-3"><div class="flex flex-col items-center">' +
                    '<div class="w-8 h-8 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold">' + (index + 1) + '</div>' +
                    (index < d.history.length - 1 ? '<div class="w-0.5 flex-1 bg-gray-300 my-1"></div>' : '') + '</div>' +
                    '<div class="flex-1 pb-4"><div class="bg-white border rounded-lg p-3"><div class="font-semibold text-sm text-gray-900">' + h.step + '</div>' +
                    '<div class="text-xs text-gray-600 mt-1">' + h.details + '</div><div class="flex justify-between items-center mt-2 text-xs text-gray-500">' +
                    '<span>👤 ' + h.user + '</span><span>🕐 ' + h.timestamp + '</span></div></div></div></div>'
                ).join('') + '</div>' : '<div class="text-center py-8 text-gray-500">No history recorded yet</div>') +
                '</div></div></div></div></div>';
        }

        function renderWorkflowSection(d) {
            if (d.responsibility === 'Contractor') return renderContractorWorkflow(d);
            if (d.responsibility === 'Owner' || d.takeoverInitiated) return renderOwnerWorkflow(d);
            return '';
        }

        function renderContractorWorkflow(d) {
         if (!d) return '<div>Error: No data</div>';
    if (!d.letters) d.letters = [];
    if (!d.pos) d.pos = [];
    if (!d.completedSteps) d.completedSteps = [];
    if (!d.ownerAction) d.ownerAction = [];
    if (!d.evidenceAssessment) d.evidenceAssessment = { evidences: [] };
    if (!d.history) d.history = [];  

 let html = '<div class="border-2 border-orange-300 rounded-lg bg-orange-50"><div class="px-4 py-3 bg-orange-100 border-b font-bold text-orange-900">Contractor Workflow</div><div class="p-4 space-y-4">';
            
            if (d.currentStep === 'notify-contractor') {
                html += '<div class="bg-white rounded-lg p-4 border-2 border-orange-500 shadow-sm"><div class="font-semibold mb-3 text-orange-900">Step 1: Notify Contractor</div>' +
                    '<div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">' +
                    '<label class="block text-xs font-semibold mb-1 text-gray-700">Contractor</label>' +
                    '<div class="text-lg font-bold text-orange-900">JO (Joint Operation)</div>' +
                    '<div class="text-xs text-gray-600 mt-1">Fixed contractor untuk semua defect tanggung jawab JO</div></div>' +
                    
                    '<div class="mb-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">' +
                    '<div class="flex items-start gap-3">' +
                    '<div class="flex-1">' +
                    '<div class="font-semibold text-sm text-green-900 mb-1">✓ JO Already Working (Proactive)?</div>' +
                    '<div class="text-xs text-gray-700">Jika JO sudah mendeteksi issue dan langsung melakukan perbaikan tanpa notifikasi dari Owner, klik tombol di bawah untuk skip notification step.</div>' +
                    '</div></div>' +
                    '<button onclick="joProactiveRepair()" class="w-full mt-3 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">' +
                    'JO Already Working - Skip to Progress</button></div>' +
                    
                    '<div class="border-t pt-4 mt-4">' +
                    '<div class="text-sm font-semibold mb-3 text-gray-700">OR Send Notification Letter:</div>' +
                    '<div class="mb-4"><div class="flex justify-between items-center mb-2"><div class="text-sm font-semibold">Letters (' + d.letters.length + ')</div>' +
                    '<button onclick="openAddLetterModal()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">+ Add Letter</button></div>' +
                    (d.letters.length > 0 ? '<div class="space-y-2 max-h-40 overflow-y-auto">' + d.letters.map(l => 
                        '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-start"><div class="flex-1">' +
                        '<div class="font-bold text-xs">' + l.letterNo + '</div><div class="text-gray-600 text-xs mt-1">' + l.subject + '</div>' +
                        '<div class="text-gray-500 text-xs mt-1">' + l.date + ' - ' + l.from + ' → ' + l.to + '</div></div>' +
                        '<button onclick="deleteLetter(' + l.id + ')" class="ml-2 px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Del</button></div>'
                    ).join('') + '</div>' : '<div class="text-sm text-gray-500">No letters added yet</div>') +
                    '</div><button onclick="notifyContractor()" class="w-full px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold">Send Notification</button></div></div>';
            } else if (d.completedSteps.includes('notify-contractor')) {
                const notificationText = d.contractorResponse === 'Accepted' && d.letters.length === 0 ? 
                    'JO proactive repair - No notification needed' : 
                    d.letters.length + ' letter(s) sent to JO (Joint Operation)';
                html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center justify-between"><div class="flex items-center gap-2">' +
                    '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
                    '<div><div class="text-sm font-semibold">Step 1: Contractor Notified</div><div class="text-xs text-gray-600">' + notificationText + '</div></div></div>' +
                    '<button onclick="unlockStep(\'notify-contractor\')" class="px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded font-medium">Edit</button></div></div>';
            }

            if (d.currentStep === 'contractor-response') {
                html += '<div class="bg-white rounded-lg p-4 border-2 border-orange-500 shadow-sm"><div class="font-semibold mb-3 text-orange-900">Step 2: Record Contractor Response</div>' +
                    '<div class="mb-4"><div class="flex justify-between items-center mb-2"><div class="text-sm font-semibold">Response Letters (' + d.letters.filter(l => ['Response','Rejection'].includes(l.type)).length + ')</div>' +
                    '<button onclick="openAddLetterModal()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">+ Add Letter</button></div>' +
                    (d.letters.filter(l => ['Response','Rejection'].includes(l.type)).length > 0 ? '<div class="space-y-2 max-h-40 overflow-y-auto">' + 
                        d.letters.filter(l => ['Response','Rejection'].includes(l.type)).map(l => 
                        '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-start"><div class="flex-1">' +
                        '<div class="font-bold text-xs">' + l.letterNo + ' - ' + l.type + '</div><div class="text-gray-600 text-xs mt-1">' + l.subject + '</div>' +
                        '<div class="text-gray-500 text-xs mt-1">' + l.date + '</div></div>' +
                        '<button onclick="deleteLetter(' + l.id + ')" class="ml-2 px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Del</button></div>'
                    ).join('') + '</div>' : '<div class="text-sm text-gray-500">No response letters yet</div>') +
                    '</div><div class="text-xs text-gray-600 mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">' +
                    '<strong>Catatan:</strong> Jika JO tidak merespon dalam batas waktu yang ditentukan, pilih "No Response" untuk melakukan takeover otomatis.</div>' +
                    '<div class="grid grid-cols-3 gap-3">' +
                    '<button onclick="contractorAccepted()" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">JO Accepted</button>' +
                    '<button onclick="contractorRejected()" class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">JO Rejected</button>' +
                    '<button onclick="contractorNoResponse()" class="px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold text-sm">No Response</button></div></div>';
            } else if (d.completedSteps.includes('contractor-response')) {
                const responseBgColor = d.contractorResponse === 'Accepted' ? 'bg-green-200 text-green-800' : 
                                       d.contractorResponse === 'Rejected' ? 'bg-red-200 text-red-800' : 
                                       'bg-yellow-200 text-yellow-800';
                html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center justify-between"><div class="flex items-center gap-2">' +
                    '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
                    '<div><div class="text-sm font-semibold">Step 2: Contractor Response: <span class="px-2 py-1 rounded text-xs font-bold ' + responseBgColor + '">' + d.contractorResponse + '</span></div></div></div>' +
                    '<button onclick="unlockStep(\'contractor-response\')" class="px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded font-medium">Edit</button></div></div>';
            }

            if ((d.contractorResponse === 'Rejected' || d.contractorResponse === 'No Response') && d.currentStep === 'evidence-assessment') {
                const ea = d.evidenceAssessment || { evidences: [], contractReview: '', technicalJustification: '', thirdPartyAssessment: '', ownerDecision: null, decisionJustification: '' };
                html += '<div class="bg-white rounded-lg p-4 border-2 border-purple-500 shadow-sm"><div class="font-semibold mb-3 text-purple-900">Step 3: Evidence & Assessment</div>' +
                    '<div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 mb-4">' +
                    '<div class="text-sm font-semibold text-purple-900 mb-1">⚖️ Legal Review Process</div>' +
                    '<div class="text-xs text-gray-700">Kumpulkan bukti dan lakukan assessment sebelum memutuskan CO Negatif untuk memperkuat posisi hukum</div></div>' +
                    
                    '<div class="mb-4"><div class="flex justify-between items-center mb-2"><div class="text-sm font-semibold">📎 Evidence Documentation (' + ea.evidences.length + ')</div></div>' +
                    (ea.evidences.length > 0 ? '<div class="space-y-2 max-h-40 overflow-y-auto mb-3">' + ea.evidences.map(e =>
                        '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-start"><div class="flex-1">' +
                        '<div class="font-bold text-xs text-blue-700">' + e.type + '</div>' +
                        '<div class="text-gray-700 text-xs mt-1">' + e.description + '</div>' +
                        '<div class="text-gray-500 text-xs mt-1">' + e.date + ' - ' + e.uploadedBy + '</div></div>' +
                        '<button onclick="deleteEvidence(' + e.id + ')" class="ml-2 px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Del</button></div>'
                    ).join('') + '</div>' : '<div class="text-sm text-gray-500 mb-3">Belum ada evidence</div>') +
                    '<div class="grid grid-cols-2 gap-2"><input type="text" id="evidence-type" placeholder="Type (e.g., Photo, Test Result, Inspection Report)" class="px-3 py-2 border rounded-lg text-sm">' +
                    '<input type="text" id="evidence-desc" placeholder="Description" class="px-3 py-2 border rounded-lg text-sm"></div>' +
                    '<button onclick="addEvidence(document.getElementById(\'evidence-type\').value, document.getElementById(\'evidence-desc\').value); document.getElementById(\'evidence-type\').value=\'\'; document.getElementById(\'evidence-desc\').value=\'\';" class="w-full mt-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">+ Add Evidence</button></div>' +
                    
                    '<div class="grid grid-cols-2 gap-4 mb-4">' +
                    '<div><label class="block text-sm font-semibold mb-1">📋 Contract & Warranty Review</label>' +
                    '<textarea rows="3" placeholder="Review kontrak, warranty terms, dan scope of work..." onchange="updateAssessmentField(\'contractReview\', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">' + (ea.contractReview || '') + '</textarea></div>' +
                    '<div><label class="block text-sm font-semibold mb-1">🔧 Technical Justification</label>' +
                    '<textarea rows="3" placeholder="Analisa teknis kenapa defect ini tanggung jawab contractor..." onchange="updateAssessmentField(\'technicalJustification\', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">' + (ea.technicalJustification || '') + '</textarea></div>' +
                    '<div class="col-span-2"><label class="block text-sm font-semibold mb-1">👨‍🔬 Third Party Expert Assessment (Optional)</label>' +
                    '<textarea rows="2" placeholder="Hasil assessment dari third party expert jika ada..." onchange="updateAssessmentField(\'thirdPartyAssessment\', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">' + (ea.thirdPartyAssessment || '') + '</textarea></div></div>' +
                    
                    '<div class="border-t-2 pt-4"><div class="text-sm font-bold mb-3 text-purple-900">Owner Decision</div>' +
                    '<div class="mb-3"><label class="block text-sm font-semibold mb-1">Justifikasi Keputusan *</label>' +
                    '<textarea rows="3" placeholder="Jelaskan alasan keputusan yang diambil berdasarkan evidence & assessment..." onchange="updateAssessmentField(\'decisionJustification\', this.value)" class="w-full px-3 py-2 border rounded-lg text-sm">' + (ea.decisionJustification || '') + '</textarea></div>' +
                    '<div class="grid grid-cols-3 gap-3">' +
                    '<button onclick="makeOwnerDecision(\'force-co-negative\')" class="p-4 border-2 rounded-lg hover:bg-red-50 border-red-500 transition">' +
                    '<div class="font-bold text-sm text-red-700">A. Force CO Negatif</div><div class="text-xs text-gray-600 mt-1">Bukti kuat, lanjut takeover</div></button>' +
                    '<button onclick="makeOwnerDecision(\'negotiate\')" class="p-4 border-2 rounded-lg hover:bg-yellow-50 border-yellow-500 transition">' +
                    '<div class="font-bold text-sm text-yellow-700">B. Negotiate/Mediate</div><div class="text-xs text-gray-600 mt-1">Coba negosiasi dulu</div></button>' +
                    '<button onclick="makeOwnerDecision(\'owner-accept\')" class="p-4 border-2 rounded-lg hover:bg-blue-50 border-blue-500 transition">' +
                    '<div class="font-bold text-sm text-blue-700">C. Owner Accept</div><div class="text-xs text-gray-600 mt-1">Bukti lemah, owner tanggung</div></button>' +
                    '</div></div></div>';
            } else if (d.completedSteps.includes('evidence-assessment')) {
                const ea = d.evidenceAssessment;
                const decisionText = ea.ownerDecision === 'force-co-negative' ? 'Force CO Negatif' :
                                    ea.ownerDecision === 'negotiate' ? 'Negotiate/Mediate' : 'Owner Accept';
                const decisionColor = ea.ownerDecision === 'force-co-negative' ? 'bg-red-200 text-red-800' :
                                     ea.ownerDecision === 'negotiate' ? 'bg-yellow-200 text-yellow-800' : 'bg-blue-200 text-blue-800';
                html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center justify-between"><div class="flex items-center gap-2">' +
                    '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
                    '<div><div class="text-sm font-semibold">Step 3: Evidence & Assessment Complete</div>' +
                    '<div class="text-xs text-gray-600 mt-1">Decision: <span class="px-2 py-1 rounded text-xs font-bold ' + decisionColor + '">' + decisionText + '</span></div>' +
                    '<div class="text-xs text-gray-600 mt-1">' + ea.evidences.length + ' evidence(s) documented</div></div></div>' +
                    '<button onclick="unlockStep(\'evidence-assessment\')" class="px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded font-medium">Edit</button></div></div>';
            }

            if ((d.contractorResponse === 'Rejected' || d.contractorResponse === 'No Response') && d.currentStep === 'takeover') {
                const reasonText = d.contractorResponse === 'Rejected' ? 'JO menolak untuk melakukan perbaikan' : 'JO tidak merespon dalam batas waktu yang ditentukan';
                const evidenceCount = d.evidenceAssessment ? d.evidenceAssessment.evidences.length : 0;
                html += '<div class="bg-white rounded-lg p-4 border-2 border-red-500 shadow-sm"><div class="font-semibold mb-3 text-red-900">Step 4: Initiate Takeover</div>' +
                    '<div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-3 mb-3">' +
                    '<div class="text-sm font-semibold text-yellow-900 mb-1">Alasan Takeover:</div>' +
                    '<div class="text-sm text-gray-700">' + reasonText + '</div>' +
                    (evidenceCount > 0 ? '<div class="text-xs text-green-700 font-semibold mt-2">✓ Didukung oleh ' + evidenceCount + ' evidence terdokumentasi</div>' : '') +
                    '</div>' +
                    '<div class="bg-red-50 p-3 rounded mb-3"><div class="text-sm text-gray-700 mb-1">CO Negatif yang akan diclaim:</div>' +
                    '<div class="text-2xl font-bold text-red-700">' + formatRupiah(d.costEstimate) + '</div></div>' +
                    '<button onclick="initiateTakeover()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">Initiate Takeover & CO Negatif</button></div>';
            } else if (d.takeoverInitiated) {
                const evidenceCount = d.evidenceAssessment ? d.evidenceAssessment.evidences.length : 0;
                if (d.completedSteps.includes('takeover')) {
                    html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center gap-2">' +
                        '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
                        '<div><div class="text-sm font-semibold">Step 4: Takeover Initiated</div>' +
                        '<div class="text-xs text-gray-600">CO Negatif: ' + formatRupiah(d.coNegative) + ' | Basis: ' + d.takeoverBasisLetter + '</div>' +
                        (evidenceCount > 0 ? '<div class="text-xs text-green-700 mt-1">✓ ' + evidenceCount + ' evidence documented</div>' : '') +
                        '</div></div></div>';
                }
                html += renderOwnerWorkflow(d);
                return html;
            }

            if (d.contractorResponse === 'Accepted' && d.currentStep === 'execution-progress') {
                html += '<div class="bg-white rounded-lg p-4 border-2 border-green-500 shadow-sm"><div class="font-semibold mb-3 text-green-900">Step 3: Work Progress</div>' +
                    '<div class="mb-3"><div class="flex justify-between mb-2"><label class="text-sm font-semibold">Progress</label>' +
                    '<span class="text-sm font-bold text-blue-700">' + d.workProgress + '%</span></div>' +
                    '<input type="range" min="0" max="100" value="' + d.workProgress + '" onchange="updateProgress(this.value)" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>' +
                    '<div class="mb-3"><label class="block text-sm font-semibold mb-1">Progress Notes</label>' +
                    '<textarea rows="3" onchange="updateProgressNotes(this.value)" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">' + (d.progressNotes || '') + '</textarea></div>' +
                    (d.workProgress >= 100 ? '<button onclick="markClosed()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Mark as Completed & Close</button>' :
                    '<div class="text-sm text-gray-600 text-center">Set progress to 100% to close defect</div>') + '</div>';
            }

            html += '</div></div>';
            return html;
        }

        function renderOwnerWorkflow(d) {
            if (!d) return '<div>Error: No data</div>';
    if (!d.letters) d.letters = [];
    if (!d.pos) d.pos = [];
    if (!d.completedSteps) d.completedSteps = [];
    if (!d.ownerAction) d.ownerAction = [];
    if (!d.history) d.history = [];

let html = '<div class="border-2 border-blue-300 rounded-lg bg-blue-50"><div class="px-4 py-3 bg-blue-100 border-b font-bold text-blue-900">Owner Workflow ' + (d.takeoverInitiated ? '(Takeover from Contractor)' : '') + '</div><div class="p-4 space-y-4">';
            
            if (d.takeoverInitiated) {
                html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center gap-2">' +
                    '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
                    '<div><div class="text-sm font-semibold">Step 3: Takeover Initiated</div>' +
                    '<div class="text-xs text-gray-600">CO Negatif: ' + formatRupiah(d.coNegative) + ' | Basis: ' + d.takeoverBasisLetter + '</div></div></div></div>';
            }

            if (d.currentStep === 'owner-action') {
                html += '<div class="bg-white rounded-lg p-4 border-2 border-blue-500 shadow-sm"><div class="font-semibold mb-3 text-blue-900">Step ' + (d.takeoverInitiated ? '4' : '1') + ': Select Owner Action (dapat pilih lebih dari 1)</div>' +
                    '<div class="grid grid-cols-3 gap-3">' +
                    ['Contract Service', 'Material Procurement', 'Self Repair'].map(action => {
                        const isSelected = d.ownerAction && d.ownerAction.includes(action);
                        return '<button onclick="setOwnerAction(\'' + action + '\')" class="p-4 border-2 rounded-lg transition ' + 
                            (isSelected ? 'border-blue-600 bg-blue-100 shadow-md' : 'border-gray-300 hover:border-blue-400 hover:bg-blue-50') + '">' +
                            '<div class="flex items-center justify-between mb-2">' +
                            '<div class="w-5 h-5 rounded border-2 flex items-center justify-center ' + 
                            (isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-400') + '">' +
                            (isSelected ? '<span class="text-white text-xs font-bold">✓</span>' : '') + '</div></div>' +
                            '<div class="font-bold text-sm text-left">' + action + '</div>' +
                            '<div class="text-xs text-gray-600 mt-1 text-left">' + 
                            (action === 'Contract Service' ? 'Kontrak Jasa' : action === 'Material Procurement' ? 'Pengadaan Material' : 'Perbaikan Sendiri') + 
                            '</div></button>';
                    }).join('') +
                    '</div>' +
                    (d.ownerAction && d.ownerAction.includes('Self Repair') ? 
                        '<div class="mt-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">' +
                        '<label class="block text-sm font-semibold mb-2 text-green-900">Self Repair - Dikerjakan oleh:</label>' +
                        '<input type="text" value="' + (d.selfRepairExecutor || '') + '" onchange="updateSelfRepairExecutor(this.value)" placeholder="Nama pelaksana atau tim..." class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">' +
                        '<div class="text-xs text-gray-600 mt-2">* Untuk Self Repair tidak perlu PO</div></div>' : '') +
                    '<div class="mt-4">' +
                    '<button onclick="confirmOwnerAction()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Confirm Selection & Continue</button>' +
                    '</div></div>';
            } else if (d.completedSteps.includes('owner-action')) {
                html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center justify-between"><div class="flex items-center gap-2">' +
                    '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
                    '<div><div class="text-sm font-semibold">Step ' + (d.takeoverInitiated ? '4' : '1') + ': Owner Action Selected</div>' +
                    '<div class="text-xs text-gray-600 mt-1">' + (d.ownerAction && d.ownerAction.length > 0 ? d.ownerAction.map(action => 
                        '<span class="inline-block px-2 py-1 rounded text-xs font-bold bg-blue-200 text-blue-800 mr-1 mb-1">' + action + '</span>'
                    ).join('') : '') + 
                    (d.selfRepairExecutor ? '<br><span class="text-green-700">Self Repair oleh: ' + d.selfRepairExecutor + '</span>' : '') +
                    '</div></div></div>' +
                    '<button onclick="unlockStep(\'owner-action\')" class="px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded font-medium">Edit</button></div></div>';
            }

            if (d.currentStep === 'proses-kontrak') {
    html += '<div class="bg-white rounded-lg p-4 border-2 border-blue-500 shadow-sm"><div class="font-semibold mb-3 text-blue-900">Step ' + (d.takeoverInitiated ? '5' : '2') + ': Proses Kontrak</div>' +
// ========== VISUAL INDICATOR - TAMBAHKAN DI SINI ==========
            (function() {
                const needsPO = d.ownerAction && 
                                (d.ownerAction.includes('Contract Service') || 
                                 d.ownerAction.includes('Material Procurement'));
                
                if (needsPO && d.pos.length === 0) {
                    return '<div class="mb-3 p-3 bg-red-50 border-2 border-red-400 rounded-lg">' +
                           '<div class="flex items-center gap-2 text-red-800 font-semibold text-sm">' +
                           '<span class="text-xl">⚠️</span>' +
                           '<span>Minimal 1 PO diperlukan untuk Contract Service/Material Procurement</span>' +
                           '</div></div>';
                }
                return '';
            })() +

                    '<div class="mb-4"><div class="flex justify-between items-center mb-2"><div class="text-sm font-semibold">POs (' + d.pos.length + ')</div>' +
                    '<button onclick="openAddPOModal()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">+ Add PO</button></div>' +
                    (d.pos.length > 0 ? '<div class="space-y-2 max-h-40 overflow-y-auto">' + d.pos.map(po =>
    '<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-start"><div class="flex-1">' +
    '<div class="font-bold text-xs">' + po.poNumber + ' - ' + po.type + '</div>' +
    '<div class="text-gray-600 text-xs mt-1">' + po.vendor + ' - ' + formatRupiah(po.value) + '</div>' +
    '<div class="text-gray-500 text-xs mt-1">' + po.description + '</div></div>' +
    '<div class="flex gap-1">' +
    '<button onclick="openEditPOModal(' + po.id + ')" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Edit</button>' +
    '<button onclick="deletePO(' + po.id + ')" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">Del</button>' +
    '</div></div>'
).join('') + '</div>' : '<div class="text-sm text-gray-500">No POs added yet</div>') +
                    '</div>' +
                    (d.ownerAction && d.ownerAction.includes('Contract Service') ? 
                        '<div class="mb-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">' +
                        '<button onclick="openStageDetailModal(\'Contract Service\')" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium text-sm">📋 View Contract Service Stages</button>' +
                        renderStageSummaryBadges('Contract Service') +
                        '</div>' : '') +
                    (d.ownerAction && d.ownerAction.includes('Material Procurement') ? 
                        '<div class="mb-3 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">' +
                        '<button onclick="openStageDetailModal(\'Material Procurement\')" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm">📋 View Material Procurement Stages</button>' +
                        renderStageSummaryBadges('Material Procurement') +
                        '</div>' : '') +
                    '<button onclick="confirmProsesKontrak()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Confirm & Continue</button></div>';
           } else if (d.completedSteps.includes('proses-kontrak')) {
    html += '<div class="bg-white rounded-lg p-3 border"><div class="flex items-center justify-between"><div class="flex items-center gap-2">' +
        '<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">✓</div>' +
        '<div><div class="text-sm font-semibold">Step ' + (d.takeoverInitiated ? '5' : '2') + ': Proses Kontrak Confirmed</div>' +
        '<div class="text-xs text-gray-600">' + d.pos.length + ' PO(s) issued</div></div></div>' +
        '<div class="flex gap-2">' +
        (d.ownerAction && d.ownerAction.includes('Contract Service') ? 
            '<button onclick="openStageDetailModal(\'Contract Service\')" class="px-3 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-1">Contract Service' +
            '<span class="ml-1 px-1.5 py-0.5 bg-white text-purple-700 rounded text-xs font-bold">' + getStageSummary('Contract Service').completed + '/' + getStageSummary('Contract Service').relevantTotal + '</span></button>' : '') +
        (d.ownerAction && d.ownerAction.includes('Material Procurement') ? 
            '<button onclick="openStageDetailModal(\'Material Procurement\')" class="px-3 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center gap-1">Material Procurement' +
            '<span class="ml-1 px-1.5 py-0.5 bg-white text-indigo-700 rounded text-xs font-bold">' + getStageSummary('Material Procurement').completed + '/' + getStageSummary('Material Procurement').relevantTotal + '</span></button>' : '') +
        '<button onclick="unlockStep(\'proses-kontrak\')" class="px-3 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded font-medium">Edit</button></div></div></div>';
    //                             ^^^^^^^^^^^^^^^^ CHANGED: dari 'issue-po' ke 'proses-kontrak'
}

            if (d.currentStep === 'execution-progress' && (d.responsibility === 'Owner' || d.takeoverInitiated)) {
    html += '<div class="bg-white rounded-lg p-4 border-2 border-green-500 shadow-sm"><div class="font-semibold mb-3 text-green-900">Step ' + (d.takeoverInitiated ? '6' : '3') + ': Execution Progress</div>' +
        '<div class="mb-3"><div class="flex justify-between mb-2"><label class="text-sm font-semibold">Progress</label>' +
        '<span class="text-sm font-bold text-blue-700">' + (d.workProgress || 0) + '%</span></div>' +
        '<input type="range" min="0" max="100" value="' + (d.workProgress || 0) + '" onchange="updateProgress(this.value)" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>' +
        '<div class="mb-3"><label class="block text-sm font-semibold mb-1">Progress Notes</label>' +
        '<textarea rows="3" onchange="updateProgressNotes(this.value)" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">' + (d.progressNotes || '') + '</textarea></div>' +
        (d.workProgress >= 100 ? '<button onclick="markClosed()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Mark as Completed & Close</button>' :
        '<div class="text-sm text-gray-600 text-center">Set progress to 100% to close defect</div>') + '</div>';
}

            html += '</div></div>';
            return html;
        }

        function renderAddLetterModal() {
            if (!state.showAddLetterModal) return '';
            
            let fromTo = '';
            if (state.newLetter.type === 'Notification' || state.newLetter.type === 'Follow-up') {
                fromTo = '<div class="col-span-2 p-3 bg-blue-50 border border-blue-200 rounded-lg"><div class="text-xs text-gray-600 mb-1">Direction:</div><div class="text-sm font-semibold text-blue-900">From: KPB (Owner) → To: JO (Joint Operation)</div></div>';
            } else if (state.newLetter.type === 'Response' || state.newLetter.type === 'Rejection') {
                fromTo = '<div class="col-span-2 p-3 bg-orange-50 border border-orange-200 rounded-lg"><div class="text-xs text-gray-600 mb-1">Direction:</div><div class="text-sm font-semibold text-orange-900">From: JO (Joint Operation) → To: KPB (Owner)</div></div>';
            }
            
            return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                '<div class="bg-white rounded-lg max-w-2xl w-full"><div class="px-6 py-4 bg-green-600 text-white"><div class="text-xl font-bold">Add Letter</div></div>' +
                '<div class="p-6 space-y-4"><div class="grid grid-cols-2 gap-4">' +
                '<div><label class="block text-sm font-semibold mb-1">Date</label><input type="date" value="' + state.newLetter.date + '" onchange="state.newLetter.date = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"></div>' +
                '<div><label class="block text-sm font-semibold mb-1">Letter No</label><input type="text" onchange="state.newLetter.letterNo = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"></div>' +
                '<div class="col-span-2"><label class="block text-sm font-semibold mb-1">Type</label><select onchange="state.newLetter.type = this.value; renderWithScrollPreserve();" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">' +
                '<option value="Notification" ' + (state.newLetter.type === 'Notification' ? 'selected' : '') + '>Notification (Owner → JO)</option>' +
                '<option value="Response" ' + (state.newLetter.type === 'Response' ? 'selected' : '') + '>Response (JO → Owner)</option>' +
                '<option value="Rejection" ' + (state.newLetter.type === 'Rejection' ? 'selected' : '') + '>Rejection (JO → Owner)</option>' +
                '<option value="Follow-up" ' + (state.newLetter.type === 'Follow-up' ? 'selected' : '') + '>Follow-up (Owner → JO)</option></select></div>' +
                fromTo +
                '<div class="col-span-2"><label class="block text-sm font-semibold mb-1">Subject</label><input type="text" onchange="state.newLetter.subject = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"></div>' +
                '</div></div><div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50">' +
                '<button onclick="closeAddLetterModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>' +
                '<button onclick="addLetter()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Letter</button></div></div></div>';
        }

        function renderAddPOModal() {
            if (!state.showAddPOModal) return '';
            return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                '<div class="bg-white rounded-lg max-w-2xl w-full"><div class="px-6 py-4 bg-blue-600 text-white"><div class="text-xl font-bold">Add PO</div></div>' +
                '<div class="p-6 space-y-4"><div class="grid grid-cols-2 gap-4">' +
                '<div class="col-span-2"><label class="block text-sm font-semibold mb-1">Type</label><select value="' + state.newPO.type + '" onchange="state.newPO.type = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
                '<option>Contract Service</option><option>Material Procurement</option><option>Self Repair</option></select></div>' +
                '<div><label class="block text-sm font-semibold mb-1">PO Number</label><input type="text" onchange="state.newPO.poNumber = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
                '<div><label class="block text-sm font-semibold mb-1">Vendor</label><input type="text" onchange="state.newPO.vendor = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
                '<div><label class="block text-sm font-semibold mb-1">Value (Rp)</label><input type="number" onchange="state.newPO.value = parseInt(this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
                '<div><label class="block text-sm font-semibold mb-1">Description</label><input type="text" onchange="state.newPO.description = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
                '</div></div><div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50">' +
                '<button onclick="closeAddPOModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>' +
                '<button onclick="addPO()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add PO</button></div></div></div>';
        }

function renderEditPOModal() {
    if (!state.showEditPOModal || !state.editPO) return '';
    return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
        '<div class="bg-white rounded-lg max-w-2xl w-full">' +
        '<div class="px-6 py-4 bg-blue-600 text-white">' +
        '<div class="text-xl font-bold">Edit PO</div></div>' +
        '<div class="p-6 space-y-4"><div class="grid grid-cols-2 gap-4">' +
        '<div class="col-span-2"><label class="block text-sm font-semibold mb-1">Type</label>' +
        '<select value="' + state.editPO.type + '" onchange="state.editPO.type = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">' +
        '<option value="Contract Service" ' + (state.editPO.type === 'Contract Service' ? 'selected' : '') + '>Contract Service</option>' +
        '<option value="Material Procurement" ' + (state.editPO.type === 'Material Procurement' ? 'selected' : '') + '>Material Procurement</option>' +
        '<option value="Self Repair" ' + (state.editPO.type === 'Self Repair' ? 'selected' : '') + '>Self Repair</option></select></div>' +
        '<div><label class="block text-sm font-semibold mb-1">PO Number</label>' +
        '<input type="text" value="' + state.editPO.poNumber + '" onchange="state.editPO.poNumber = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
        '<div><label class="block text-sm font-semibold mb-1">Vendor</label>' +
        '<input type="text" value="' + state.editPO.vendor + '" onchange="state.editPO.vendor = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
        '<div><label class="block text-sm font-semibold mb-1">Value (Rp)</label>' +
        '<input type="number" value="' + state.editPO.value + '" onchange="state.editPO.value = parseInt(this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
        '<div><label class="block text-sm font-semibold mb-1">Description</label>' +
        '<input type="text" value="' + state.editPO.description + '" onchange="state.editPO.description = this.value" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></div>' +
        '</div></div>' +
        '<div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50">' +
        '<button onclick="closeEditPOModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>' +
        '<button onclick="updatePO()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update PO</button>' +
        '</div></div></div>';
}

        function renderEditResponsibilityModal() {
            if (!state.showEditResponsibilityModal) return '';
            return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
                '<div class="bg-white rounded-lg max-w-lg w-full"><div class="px-6 py-4 bg-purple-600 text-white"><div class="text-xl font-bold">Change Responsibility</div></div>' +
                '<div class="p-6"><div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">' +
                '<div class="font-semibold text-yellow-800 mb-2">Warning</div><div class="text-sm text-yellow-700">Mengubah responsibility akan mereset semua workflow progress. Data history tetap tersimpan.</div></div>' +
                '<div class="mb-4"><div class="text-sm text-gray-600 mb-2">Current Responsibility:</div><div class="text-xl font-bold">' + state.selectedItem.responsibility + '</div></div>' +
                '<div class="text-sm font-semibold mb-3 text-gray-700">Change To:</div><div class="grid grid-cols-2 gap-3">' +
                '<button onclick="changeResponsibility(\'Contractor\')" class="p-4 border-2 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition ' + (state.selectedItem.responsibility === 'Contractor' ? 'opacity-50 cursor-not-allowed' : '') + '" ' + (state.selectedItem.responsibility === 'Contractor' ? 'disabled' : '') + '>' +
                '<div class="font-bold">JO (Contractor)</div></button>' +
                '<button onclick="changeResponsibility(\'Owner\')" class="p-4 border-2 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition ' + (state.selectedItem.responsibility === 'Owner' ? 'opacity-50 cursor-not-allowed' : '') + '" ' + (state.selectedItem.responsibility === 'Owner' ? 'disabled' : '') + '>' +
                '<div class="font-bold">KPB (Owner)</div></button></div></div>' +
                '<div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50">' +
                '<button onclick="closeEditResponsibilityModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">Cancel</button></div></div></div>';
        }

        function renderEditBasicInfoModal() {
    if (!state.showEditBasicInfoModal || !state.editBasicInfo) return '';
    return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
        '<div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">' +
        '<div class="px-6 py-4 bg-green-600 text-white"><div class="text-xl font-bold">Edit Basic Info - ' + state.selectedItem.id + '</div></div>' +
        '<div class="p-6 space-y-6"><div class="grid grid-cols-2 gap-4">' +
        
        // Title
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Title</label>' +
        '<input type="text" value="' + state.editBasicInfo.title + '" onchange="updateEditBasicInfo(\'title\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // Equipment
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Equipment</label>' +
        '<input type="text" value="' + state.editBasicInfo.equipment + '" onchange="updateEditBasicInfo(\'equipment\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // ========== UNIT DESCRIPTION ==========
        '<div class="col-span-2"><label class="block text-sm font-semibold mb-1 text-gray-700">Unit Description</label>' +
        '<select onchange="updateEditBasicInfo(\'unitDescription\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">' +
        '<option value="">-- Select Unit --</option>' +
        UNIT_OPTIONS.map(unit => 
            '<option value="' + unit + '" ' + ((state.editBasicInfo.unitDescription || '') === unit ? 'selected' : '') + '>' + unit + '</option>'
        ).join('') +
        '</select></div>' +
        // ======================================
        
        // Location
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Location</label>' +
        '<input type="text" value="' + state.editBasicInfo.location + '" onchange="updateEditBasicInfo(\'location\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // Phase
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Phase</label>' +
        '<select onchange="updateEditBasicInfo(\'phase\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">' +
        '<option value="commissioning" ' + (state.editBasicInfo.phase === 'commissioning' ? 'selected' : '') + '>Commissioning</option>' +
        '<option value="startup" ' + (state.editBasicInfo.phase === 'startup' ? 'selected' : '') + '>Start-Up</option>' +
        '<option value="oa" ' + (state.editBasicInfo.phase === 'oa' ? 'selected' : '') + '>OA</option>' +
        '<option value="fa" ' + (state.editBasicInfo.phase === 'fa' ? 'selected' : '') + '>FA</option>' +
        '<option value="warranty" ' + (state.editBasicInfo.phase === 'warranty' ? 'selected' : '') + '>Warranty</option>' +
        '</select></div>' +
        
        // Discipline
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Discipline</label>' +
        '<select onchange="updateEditBasicInfo(\'discipline\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">' +
        '<option value="Static" ' + (state.editBasicInfo.discipline === 'Static' ? 'selected' : '') + '>Static</option>' +
        '<option value="Rotating" ' + (state.editBasicInfo.discipline === 'Rotating' ? 'selected' : '') + '>Rotating</option>' +
        '<option value="Electrical" ' + (state.editBasicInfo.discipline === 'Electrical' ? 'selected' : '') + '>Electrical</option>' +
        '<option value="Instrument" ' + (state.editBasicInfo.discipline === 'Instrument' ? 'selected' : '') + '>Instrument</option>' +
        '</select></div>' +
        
        // Defect Date
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Defect Date</label>' +
        '<input type="date" value="' + state.editBasicInfo.defectDate + '" onchange="updateEditBasicInfo(\'defectDate\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // Target Date
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Target Date</label>' +
        '<input type="date" value="' + state.editBasicInfo.targetDate + '" onchange="updateEditBasicInfo(\'targetDate\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // Reported By
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Reported By</label>' +
        '<input type="text" value="' + state.editBasicInfo.reportedBy + '" onchange="updateEditBasicInfo(\'reportedBy\', this.value)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // Cost Estimate
        '<div><label class="block text-sm font-semibold mb-1 text-gray-700">Cost Estimate (Rp)</label>' +
        '<input type="number" value="' + state.editBasicInfo.costEstimate + '" onchange="updateEditBasicInfo(\'costEstimate\', parseInt(this.value) || 0)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"></div>' +
        
        // Critical Checkbox
        '<div class="col-span-2"><label class="flex items-center gap-2 cursor-pointer">' +
        '<input type="checkbox" ' + (state.editBasicInfo.isCritical ? 'checked' : '') + ' onchange="updateEditBasicInfo(\'isCritical\', this.checked)" class="w-5 h-5 rounded border-gray-300 text-red-600 focus:ring-red-500">' +
        '<span class="text-sm font-semibold text-gray-700">⚠️ Mark as CRITICAL (perhatian khusus)</span></label></div>' +
        
        // Description
        '<div class="col-span-2"><label class="block text-sm font-semibold mb-1 text-gray-700">Description</label>' +
        '<textarea onchange="updateEditBasicInfo(\'description\', this.value)" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">' + state.editBasicInfo.description + '</textarea></div>' +
        
        // Root Cause
        '<div class="col-span-2"><label class="block text-sm font-semibold mb-1 text-gray-700">Root Cause</label>' +
        '<textarea onchange="updateEditBasicInfo(\'rootCause\', this.value)" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">' + state.editBasicInfo.rootCause + '</textarea></div>' +
        
        '</div></div>' +
        
        // Footer Buttons
        '<div class="px-6 py-4 border-t flex justify-end gap-3 bg-gray-50">' +
        '<button onclick="closeEditBasicInfoModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">Cancel</button>' +
        '<button onclick="saveBasicInfo()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Save Changes</button>' +
        '</div></div></div>';
}

        function renderStageDetailModal() {
    if (!state.showStageDetailModal || !state.selectedItem) return '';
    const stages = state.selectedStageType === 'Contract Service' ? 
        state.selectedItem.contractServiceStages : 
        state.selectedItem.materialProcurementStages;
    
    const notStartedCount = stages.filter(s => s.status === 'not-started').length;
    const inProgressCount = stages.filter(s => s.status === 'in-progress').length;
    const completedCount = stages.filter(s => s.status === 'completed').length;
    const notRequiredCount = stages.filter(s => s.status === 'not-required').length;
    
    const relevantStagesCount = stages.length - notRequiredCount;
    
    const bgColor = state.selectedStageType === 'Contract Service' ? 'bg-purple-600' : 'bg-indigo-600';
    
    return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">' +
        '<div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">' +
        '<div class="px-6 py-4 ' + bgColor + ' text-white flex justify-between items-center">' +
        '<div><div class="text-xl font-bold">' + state.selectedStageType + ' Stages</div>' +
        '<div class="text-sm opacity-90 mt-1">' + state.selectedItem.id + ' - ' + state.selectedItem.title + '</div></div>' +
        '<button onclick="closeStageDetailModal()" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-1 rounded font-medium">Close</button></div>' +
        '<div class="p-4 bg-gray-50 border-b"><div class="grid grid-cols-4 gap-4 text-center">' +
        '<div class="bg-yellow-100 rounded-lg p-3"><div class="text-2xl font-bold text-yellow-700">' + notStartedCount + '</div><div class="text-xs text-yellow-600 font-semibold">Not Started</div></div>' +
        '<div class="bg-green-100 rounded-lg p-3"><div class="text-2xl font-bold text-green-700">' + inProgressCount + '</div><div class="text-xs text-green-600 font-semibold">In Progress</div></div>' +
        '<div class="bg-blue-100 rounded-lg p-3"><div class="text-2xl font-bold text-blue-700">' + completedCount + '</div><div class="text-xs text-blue-600 font-semibold">Completed</div></div>' +
        '<div class="bg-gray-100 rounded-lg p-3"><div class="text-2xl font-bold text-gray-700">' + notRequiredCount + '</div><div class="text-xs text-gray-600 font-semibold">Not Required</div></div>' +
        '</div></div>' +
        '<div class="flex-1 overflow-y-auto p-6"><div class="space-y-3">' +
        stages.map((stage, index) => {
            const statusColors = {
                'not-started': 'bg-yellow-50 border-yellow-300',
                'in-progress': 'bg-green-50 border-green-300',
                'completed': 'bg-blue-50 border-blue-300',
                'not-required': 'bg-gray-50 border-gray-300'
            };
            
            return '<div class="border-2 rounded-lg p-4 ' + statusColors[stage.status] + '">' +
                '<div class="flex items-start gap-3">' +
                '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-white border-2 flex items-center justify-center font-bold text-sm ' + 
                (stage.status === 'not-started' ? 'border-yellow-500 text-yellow-700' :
                 stage.status === 'in-progress' ? 'border-green-500 text-green-700' :
                 stage.status === 'completed' ? 'border-blue-500 text-blue-700' : 
                 'border-gray-400 text-gray-600') + '">' + (index + 1) + '</div>' +
                '<div class="flex-1">' +
                '<div class="font-semibold text-sm text-gray-900 mb-2">' + stage.name + '</div>' +
                
                '<div class="flex gap-2 mb-3 flex-wrap">' +
                '<button onclick="updateStageStatus(' + index + ', \'not-started\')" class="px-3 py-1 text-xs rounded-lg font-semibold ' + 
                (stage.status === 'not-started' ? 'bg-yellow-600 text-white' : 'bg-white border border-yellow-600 text-yellow-600 hover:bg-yellow-50') + '">⏸ Not Started</button>' +
                '<button onclick="updateStageStatus(' + index + ', \'in-progress\')" class="px-3 py-1 text-xs rounded-lg font-semibold ' + 
                (stage.status === 'in-progress' ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-600 hover:bg-green-50') + '">▶ In Progress</button>' +
                '<button onclick="updateStageStatus(' + index + ', \'completed\')" class="px-3 py-1 text-xs rounded-lg font-semibold ' + 
                (stage.status === 'completed' ? 'bg-blue-600 text-white' : 'bg-white border border-blue-600 text-blue-600 hover:bg-blue-50') + '">✓ Completed</button>' +
                '<button onclick="updateStageStatus(' + index + ', \'not-required\')" class="px-3 py-1 text-xs rounded-lg font-semibold ' + 
                (stage.status === 'not-required' ? 'bg-gray-600 text-white' : 'bg-white border border-gray-600 text-gray-600 hover:bg-gray-50') + '">✕ Not Required</button>' +
                '</div>' +
                
                (stage.status === 'not-started' || stage.status === 'in-progress' ? 
                    '<div class="mb-2"><label class="block text-xs font-semibold mb-1 text-gray-700">Target Date</label>' +
                    '<input type="date" value="' + (stage.targetDate || '') + '" onchange="updateStageTargetDate(' + index + ', this.value)" class="w-full px-2 py-1 border rounded text-xs focus:ring-2 focus:ring-' + (state.selectedStageType === 'Contract Service' ? 'purple' : 'indigo') + '-500"></div>' +
                    '<div><label class="block text-xs font-semibold mb-1 text-gray-700">Notes</label>' +
                    '<textarea placeholder="Add notes..." onchange="updateStageNotes(' + index + ', this.value)" rows="2" class="w-full px-3 py-2 border rounded-lg text-xs focus:ring-2 focus:ring-' + (state.selectedStageType === 'Contract Service' ? 'purple' : 'indigo') + '-500">' + (stage.notes || '') + '</textarea></div>'
                : stage.status === 'completed' ?
                    '<div class="mb-2"><label class="block text-xs font-semibold mb-1 text-gray-700">Target Date</label>' +
                    '<input type="date" value="' + (stage.targetDate || '') + '" readonly class="w-full px-2 py-1 border rounded text-xs bg-gray-100 cursor-not-allowed"></div>' +
                    '<div class="mb-2"><label class="block text-xs font-semibold mb-1 text-gray-700">Actual Completion Date</label>' +
                    '<input type="date" value="' + (stage.actualDate || '') + '" onchange="updateStageActualDate(' + index + ', this.value)" class="w-full px-2 py-1 border rounded text-xs focus:ring-2 focus:ring-blue-500"></div>' +
                    '<div><label class="block text-xs font-semibold mb-1 text-gray-700">Notes</label>' +
                    '<textarea placeholder="Add notes..." onchange="updateStageNotes(' + index + ', this.value)" rows="2" class="w-full px-3 py-2 border rounded-lg text-xs focus:ring-2 focus:ring-' + (state.selectedStageType === 'Contract Service' ? 'purple' : 'indigo') + '-500">' + (stage.notes || '') + '</textarea></div>'
                : stage.status === 'not-required' ?
                    '<div><label class="block text-xs font-semibold mb-1 text-gray-700">Notes (Optional)</label>' +
                    '<textarea placeholder="Add notes..." onchange="updateStageNotes(' + index + ', this.value)" rows="2" class="w-full px-3 py-2 border rounded-lg text-xs focus:ring-2 focus:ring-gray-500">' + (stage.notes || '') + '</textarea></div>'
                : '') +
                
                '</div></div></div>';
        }).join('') +
        '</div></div>' +
        '<div class="px-6 py-4 border-t bg-gray-50 flex justify-between items-center">' +
        '<div class="text-sm text-gray-600">Progress: <span class="font-bold text-blue-700">' + completedCount + '</span> of <span class="font-bold text-blue-700">' + relevantStagesCount + '</span> stages completed' +
        (notRequiredCount > 0 ? ' <span class="text-gray-500">(' + notRequiredCount + ' not required)</span>' : '') + '</div>' +
        '<button onclick="closeStageDetailModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">Done</button>' +
        '</div></div></div>';
}

        function renderProgressBar(defect) {
            const steps = [];
            if (defect.responsibility === 'Contractor') {
                steps.push({ name: 'notify-contractor', label: 'Notify Contractor' }, { name: 'contractor-response', label: 'Contractor Response' });
                if (defect.contractorResponse === 'Rejected' || defect.contractorResponse === 'No Response') {
                    steps.push({ name: 'evidence-assessment', label: 'Evidence & Assessment' });
                    if (defect.evidenceAssessment && defect.evidenceAssessment.ownerDecision === 'force-co-negative') {
                        steps.push({ name: 'takeover', label: 'Takeover' }, { name: 'owner-action', label: 'Owner Action' });
                        const onlySelfRepair = defect.ownerAction && defect.ownerAction.length === 1 && defect.ownerAction[0] === 'Self Repair';
                        if (!onlySelfRepair) steps.push({ name: 'issue-po', label: 'Issue PO' });
                    }
                }
                steps.push({ name: 'execution-progress', label: 'Execution Progress' });
            } else {
                steps.push({ name: 'owner-action', label: 'Owner Action' });
                const onlySelfRepair = defect.ownerAction && defect.ownerAction.length === 1 && defect.ownerAction[0] === 'Self Repair';
                if (!onlySelfRepair) steps.push({ name: 'issue-po', label: 'Issue PO' });
                steps.push({ name: 'work-progress', label: 'Work Progress' });
            }
            return '<div class="mb-6"><div class="flex items-center justify-between">' + steps.map((step, index) => {
                const status = getStepStatus(defect, step.name);
                return '<div class="flex-1 ' + (index > 0 ? 'ml-2' : '') + '"><div class="relative">' +
                    (index > 0 ? '<div class="absolute top-5 left-0 w-full h-1 ' + (status === 'completed' ? 'bg-green-500' : 'bg-gray-300') + '" style="transform: translateX(-50%); width: calc(100% + 0.5rem);"></div>' : '') +
                    '<div class="relative flex flex-col items-center"><div class="w-10 h-10 rounded-full flex items-center justify-center ' +
                    (status === 'completed' ? 'bg-green-500 text-white' : status === 'current' ? 'bg-blue-500 text-white animate-pulse' : 'bg-gray-300 text-gray-600') +
                    ' font-bold text-sm z-10">' + (status === 'completed' ? '✓' : index + 1) + '</div>' +
                    '<div class="text-xs font-semibold mt-2 text-center ' + (status === 'current' ? 'text-blue-600' : 'text-gray-600') + '">' + step.label + '</div></div></div></div>';
            }).join('') + '</div></div>';
        }

        function createCharts() {
    setTimeout(() => {
        const stats = getStats();
        
        // Status Chart - NEW COLORS
        const ctx1 = document.getElementById('statusChart');
        if (ctx1) {
            if (window.statusChartInstance) window.statusChartInstance.destroy();
            window.statusChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Open', 'In Progress', 'Closed'],
                    datasets: [{
                        data: [stats.open, stats.inProgress, stats.closed],
                        backgroundColor: [
                            '#6b7280', // Gray for Open
                            '#22c55e', // Green for In Progress
                            '#3b82f6'  // Blue for Closed
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12, weight: 'bold' },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    cutout: '65%'
                }
            });
        }
        
        // Responsibility Chart
        const ctx2 = document.getElementById('responsibilityChart');
        if (ctx2) {
            if (window.responsibilityChartInstance) window.responsibilityChartInstance.destroy();
            const contractor = state.defects.filter(d => d.responsibility === 'Contractor').length;
            const owner = state.defects.filter(d => d.responsibility === 'Owner').length;
            window.responsibilityChartInstance = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: ['Contractor (JO)', 'Owner (KPB)'],
                    datasets: [{
                        data: [contractor, owner],
                        backgroundColor: ['#f97316', '#3b82f6'],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12, weight: 'bold' },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    }
                }
            });
        }
        
        // Phase Chart
        const ctx3 = document.getElementById('phaseChart');
        if (ctx3) {
            if (window.phaseChartInstance) window.phaseChartInstance.destroy();
            window.phaseChartInstance = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.byPhase).map(p => p.toUpperCase()),
                    datasets: [{
                        label: 'Defects',
                        data: Object.values(stats.byPhase),
                        backgroundColor: '#8b5cf6',
                        borderRadius: 8,
                        hoverBackgroundColor: '#7c3aed'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, font: { weight: 'bold' } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } }
                        }
                    }
                }
            });
        }
    }, 100);
}

        // Due to length limits, continuing with render functions...
        // File is too long for single artifact - continuing in next message with FILE PART 2
        
function render() {
    const app = document.getElementById('app');
    if (!app) return;
    
    try {
        app.innerHTML = '<div class="bg-white shadow-sm border-b"><div class="max-w-7xl mx-auto px-6 py-6">' +
    '<div class="flex items-center justify-between">' +
    '<div><h1 class="text-3xl font-bold text-gray-900">D&D Management System</h1>' +
    '<p class="text-gray-600 mt-1">Defect & Deficiency Management - Flow-Based Tracking</p></div>' +
    '<div class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-full shadow-lg">' +
    '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>' +
    '<div class="flex items-center gap-2">' +
    '<span class="text-sm font-semibold">Online Users:</span>' +
    '<span class="text-xl font-bold">' + onlineUsersCount + '</span>' +
    '</div></div></div></div></div>' +
            '<div class="bg-white shadow-sm sticky top-0 z-40 border-b"><div class="max-w-7xl mx-auto"><div class="flex space-x-8 px-6">' +
            '<button onclick="setActiveTab(\'dashboard\')" class="py-4 px-2 border-b-2 font-medium transition ' + (state.activeTab === 'dashboard' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700') + '">Dashboard</button>' +
            '<button onclick="setActiveTab(\'defects\')" class="py-4 px-2 border-b-2 font-medium transition ' + (state.activeTab === 'defects' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700') + '">Defects List</button>' +
            '</div></div></div><div class="max-w-7xl mx-auto p-6 pb-20">' +
            (state.activeTab === 'dashboard' ? renderDashboard() : renderDefectsList()) +
            '</div><footer class="bg-slate-900 text-slate-400 py-6 mt-12 border-t border-slate-800">' +
            '<div class="max-w-7xl mx-auto px-6 text-center">' +
            '<div class="text-sm font-medium">Developed by TS-KPB</div>' +
            '<div class="text-xs mt-1 opacity-60">© 2025 All Rights Reserved</div>' +
            '</div></footer>' +
            renderAddModal() + renderDetailModal() + renderEditResponsibilityModal() + renderEditBasicInfoModal() + renderAddLetterModal() + renderAddPOModal() + renderEditPOModal() + renderStageDetailModal();
    } catch (error) {
        console.error('Render error:', error);
        app.innerHTML = '<div style="padding: 40px; text-align: center; font-family: Arial;">' +
            '<h1 style="color: #dc2626; margin-bottom: 20px;">⚠️ Page Error</h1>' +
            '<p style="color: #666; margin-bottom: 20px;">Something went wrong loading this page.</p>' +
            '<button onclick="location.reload()" style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">Refresh Page (F5)</button>' +
            '<div style="margin-top: 20px; padding: 15px; background: #fee2e2; border-left: 4px solid #dc2626; text-align: left; font-size: 14px;"><strong>Error:</strong> ' + error.message + '</div>' +
            '</div>';
    }
}


        async function init() {
            try {
                await initAuth();
                await setupPresence();  // ← TAMBAHKAN BARIS INI
                listenToDefects();
            } catch (error) {
                console.error('Init error:', error);
                alert('Error: ' + error.message);
            }
        }

        init();
    </script>
</body>
</html>
